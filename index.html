<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mahindra Armored ‚Äî Service Network</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Georama:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  html,body,#map{height:100%;margin:0}
  body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  /* üõ†Ô∏è MODIFIED: Changes panel from horizontal to vertical, removes max-width */
.panel{
  position:absolute;top:10px;left:10px;z-index:2;background:transparent;
  padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.12);
  font-family: 'Georama', sans-serif;
  
  /* NEW LAYOUT PROPERTIES */
  display: flex;
  flex-direction: column; 
  gap: 15px; /* Space between the filter group and locate button group */
  max-width: fit-content; 
  width: 10vw; /* KEPT AS REQUESTED */
  font-size: 0.6vw;
  flex-wrap: nowrap;
}
  .panel label{display:flex;gap:6px;align-items:center}
  .panel select,.panel button{padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px;background:#fff}
  .panel button{cursor:pointer}
  .k{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:6px;vertical-align:middle}
  .legend-item.red{background-color:#e41837;border:1px solid #e41837}
  .legend-item.white{background-color:#ffffff;border:1px solid #e41837}
  .mapboxgl-popup-content{
  padding: 10px 10px 10px 10px; /* Reduced bottom padding to 0 */
  max-width: min(90vw,420px);
}
  .popup h3{margin:0 0 4px;font-size:clamp(14px,1.5vw,18px)}
  .popup p{margin:0;font-size:clamp(12px,1.3vw,14px);line-height:1.35;overflow-wrap:anywhere}
  .popup-footer{
    position: absolute;
    bottom: 0; /* Use a negative value to compensate for the removed padding and the Mapbox wrapper */
    left: 0;
    width: 100%;
    height: 3px;
    background: #ffffff;
    border-radius: 0 0 10px 10px;
}
  .popup {

    position: relative;
    font-family: 'Georama', sans-serif;
  }

.popup::before {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 100%;
  height: 100%;
  background: url('watermark.png') center center/200px no-repeat;
  opacity: 0.1;
  pointer-events: none;
  z-index: 0;

  /* New lines to keep the image diagonal */
  transform: translate(-50%, -50%) rotate(-30deg);
  transform-origin: center;
}

  .popup * {
    position: relative;
    z-index: 1;
  }


/* Container to hold the buttons, using flexbox for alignment */
.contact-buttons {
    display: flex; /* Arranges children side-by-side */
    gap: 10px; /* Space between the buttons */
    margin-top: 20px; /* Adds space above the buttons */
    justify-content: center; /* Centers the buttons horizontally in the popup */
}

/* Styling the links to look like buttons */
.contact-buttons a {
    /* Basic Button Look */
    display: inline-block; /* Essential for padding/margin */
    padding: 5px 5px;
    border-radius: 4px;
    text-decoration: none; /* Removes the underline */
    text-align: center;
    font-weight: bold;
    cursor: pointer;
    white-space: nowrap; /* Prevents button text from wrapping */
    
    /* üëá CHANGED: Default state is white background, red text, and red border */
    background-color: white; /* Default white background */
    color: #E41837; /* Default red text */
    border: 1px solid #E41837; /* Red border */
    
    /* Optional: Hover effect */
    transition: background-color 0.2s, color 0.2s, border-color 0.2s;
}

.contact-buttons a:hover {
    /* üëá CHANGED: On hover, background becomes red and text becomes white (or a very light shade of red to ensure legibility on the red background) */
    background-color: #E41837; /* Red background on hover */
    color: white; /* White text on hover for contrast */
    border-color: #E41837; /* Keep border red */
}

/* Ensure the image inside the button is aligned nicely */
.contact-buttons a img {
    margin-right: 5px; /* Add a little space between icon and text */
}

.hub-id-container {
  /* Retain your existing properties */
  display: inline-flex;
  align-items: center;
  gap: 8px; /* Assuming you are using the gap from your previous code */
  
  /* Add the horizontal line (top border) */
  border-top: .5px solid #CCCCCC; 
border-bottom: .5px solid #CCCCCC;
  
  /* Add vertical spacing to separate content */
  padding-top: 10px; /* Space between the line and the Hub ID content */
  margin-top: 10px;
padding-bottom: 10px;
margin-bottom: 10px;  /* Space between the contact buttons and the line */
}

.hub-id-badge {
    /* The Badge Look */
    background-color: #f0f3f5; /* Very light, cool background */
    color: #4a5568; /* Dark, readable text color */
    border: 1px solid #e2e8f0; /* Subtle border */
    border-radius: 4px; /* Slight rounding, not a full pill */
    padding: 4px 8px;

    /* The Code Look */
    font-size: 0.9em; /* Slightly smaller than main text */
    font-weight: 500; /* Medium weight */
    font-family: 'SFMono-Regular', 'Consolas', 'Courier New', monospace; 
    /* Use a clear monospace font */
    letter-spacing: 0.5px; /* Spacing can help with readability of slashes */
    user-select: all; /* Allows easy highlighting and copying */
}

.hub-header {
    /* 1. Turn on Flexbox */
    display: flex;
    
    /* 2. Alignment (Optional but recommended) */
    align-items: center; 
vertical-align: middle;
    /* This centers the logo and label vertically, useful if they have different heights */
    
    /* 3. Spacing (Optional) */
    gap: 10px; 
    /* Adds a clean 10px space between the logo and the label */
}


/* --- Logo + Country row --- */
.popup .logo-country {
  display: flex;
  align-items: center;            /* vertical centering regardless of logo height */
  gap: 12px;                      /* space between logo and text */
  margin: 8px 0 10px;              /* balanced vertical rhythm */
}

.popup .logo-country .logo-wrapper {
  flex-shrink: 0;                 /* prevent logo squish */
  display: flex;
  align-items: center;
  justify-content: center;
  height: 42px;                   /* consistent row height */
  min-width: 42px;                 /* keeps text from jumping left on smaller logos */
}

/* Ensure any <img> inside ${logoHTML} scales cleanly */
.popup .logo-country .logo-wrapper img {
  max-height: 42px;               /* cap height; preserves aspect ratio */
  width: auto;
  display: block;
  object-fit: contain;
}

/* Country text reset (pairs well with .popup p defaults) */
.popup .logo-country p {
  margin: 0;
  line-height: 1.3;
}

/* --- Service range block spacing --- */
.popup .service-range {
  margin: 10px 0 12px;
}
.popup .service-range > p {
  margin: 0 0 6px;
}

/* --- Contact buttons: use your existing styles, just tighten spacing --- */
.popup .contact-buttons {
  /* you already have display:flex, gap:10px, justify-content:center */
  margin-top: 12px;               /* reduce from 20px for tighter layout */
  margin-bottom: 10px;
padding-bottom:10px;             /* add a bit of breathing room below */
}

/* --- Hub ID container: align baseline and tidy spacing --- */
.popup .hub-id-container {
  display: inline-flex;          /* you already had inline-flex; switch to gap instead of margin-left */
  align-items: left;
  gap: 8px;                      /* replaces margin-left on the badge wrapper */
  margin-top: 6px;
}

/* Optional: make the hub-id badge pop a hair more */
.popup .hub-id-badge {
  background-color: #ffffff;
  color: #000000;
  border: 1px solid #e2e8f0;
  border-radius: 4px;
  padding: 3px 8px;              /* slightly slimmer vertical padding */
  font-size: 0.9em;
  font-weight: 500;
  font-family: 'SFMono-Regular', 'Consolas', 'Courier New', monospace;
  letter-spacing: 0.5px;
  user-select: all;
}

/* --- Mapbox footer overlap safety ---
    You have an absolutely-positioned footer (height: 3px).
    Give the popup a tiny bottom padding so content never sits under it.
*/
.mapboxgl-popup-content {
  padding-bottom: 12px;           /* was 10px; small bump to guarantee clearance */
}
#legend-footer{
      position:absolute;
      bottom:10px; /* Distance from the bottom edge */
      left:50%;
      transform:translateX(-50%); /* Center horizontally */
      z-index:2;
      background:transparent;
      padding:10px 15px;
      border-radius:10px;
      box-shadow:0 6px 18px rgba(0,0,0,.12);
      font-family: 'Georama', sans-serif;
      /* Max-width added to keep it tidy */
      max-width: fit-content; 
    }

.filter-pill {
    /* üí• MODIFIED: Increased padding and added width/box-sizing for full-width vertical stacking */
    padding: 0.6vw 0.8vw; /* New responsive padding for cleaner list item look */
    width: 100%; /* Forces the pill to span the full 10vw width */
    box-sizing: border-box; /* Ensures padding/border are included in the 100% width */
    text-align: left; /* Aligns text neatly to the left */

    border: 1px solid #e5e7eb;
    border-radius: 20px; /* High radius for pill shape */
    background: #f8f9fa; /* Light background for non-selected */
    color: #4b5563;
    cursor: pointer;
    font-size: 0.6vw; 
    font-weight: 500;
    transition: all 0.2s ease;
    /* white-space: nowrap; is now unnecessary and removed by not including it here */
font-family: 'Georama', sans-serif;
}

.filter-pill:hover:not(.active) {
    background: #e41837;
    border-color: #e41837;
color: #ffffff;
font-family: 'Georama', sans-serif;
}

.filter-pill.active {
    background: #e41837; /* Mahindra Red */
    color: #ffffff;
    border-color: #e41837;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
font-family: 'Georama', sans-serif;
}


/* --- New Panel Layout and Structure Rules --- */
.panel-group {
    display: flex;
    flex-direction: column; 
    gap: 10px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f0f0f0; 
}

.panel-group:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.panel-label {
    font-weight: 600; 
    color: #ffffff;
    font-size: 0.6vw; /* This is correct for consistency */
text-align: center;
font-family: 'Georama', sans-serif;
}

#regionFilterPills {
    /* üí• MODIFIED: Forces vertical stacking of pills */
    display: flex;
    flex-direction: column; /* FORCES vertical stacking */
    flex-wrap: nowrap;
    /* Keep gap small and responsive */
    gap: 0.4vw; 
}

/* --- Branding for Action Button (Find Near Me) --- */

#locateMe {
    /* Resets and overrides default .panel button styles */
    
    /* üõ†Ô∏è MODIFIED: Light gray background */
    background-color: #f0f0f0; 
    
    /* üõ†Ô∏è MODIFIED: Red text color */
    color:  #000000; 
    
    /* üõ†Ô∏è MODIFIED: Subtle border */
    border: 1px solid #dcdcdc; 
    
    font-weight: 500;
    padding: 8px 12px; 
    border-radius: 8px; 
    /* üõ†Ô∏è MODIFIED: Use a very subtle, light shadow */
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); 
    
    transition: all 0.2s ease;
font-family: 'Georama', sans-serif;
/* ADDED: Explicitly set font-size to 0.8vw for completeness */
font-size: 0.6vw;
}

#locateMe:hover {
    /* Slightly darker gray on hover */
    background-color: #e5e5e5; 
    /* No change to text/border color */
    border-color: #E000000; 
    /* Keep existing hover shadow or remove it */
color: #E41837;    
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
font-family: 'Georama', sans-serif;
}


  </style>
</head>
<body>


 <div class="panel" aria-label="Map controls">

<div id="geocoder-container" class="panel-group filter-controls">
         <div class="panel-label">Search Country</div> 
          </div>

      <div class="panel-group filter-controls">
          <div class="panel-label">Filter by Region</div>
          <div id="regionFilterPills">
              </div>
      </div>
      
      

      <div class="panel-group action-controls">
          <button id="locateMe" aria-label="Use my location">üìç MEVA Regional Hubs near me</button>
      </div>
  </div>

  <div id="legend-footer" role="contentinfo" aria-label="Map legend">
    <div style="
        display:flex; 
        gap:20px; 
        align-items: center;
        justify-content: center;
        font-size: 0.6vw;
    ">
      <div style="display:flex; align-items:center;">
        <img src="manufacturing.png" alt="Manufacturing Icon" style="width:25px; height:25px; margin-right:8px; vertical-align:middle;"> 
        Armoured Vehicle(AV) Manufacturing Facility
      </div>
      <div style="display:flex; align-items:center;">
        <img src="support.png" alt="Support Icon" style="width:25px; height:25px; margin-right:8px; vertical-align:middle;"> 
        Regional Support Hubs for AV's
      </div>
    </div>
  </div>

  <div id="map" role="region" aria-label="Global Service Network"></div>

  <script>
  // ====== CONFIG ======
  const MAPBOX_TOKEN = 'pk.eyJ1IjoibnJhanBrIiwiYSI6ImNtZnFoejJhaDBua2cybHM4dHRtZ2xycW4ifQ.wAJkzxTCQiRmIZuSyW59Uw';
  const HYGRAPH_ENDPOINT = 'https://ap-south-1.cdn.hygraph.com/content/cmfpk332g005s08uylh0ezd8a/master';

  const REGION_LABEL = {
    AMER: 'üåé AMER: North & Latin America',
    EMEA: 'üåç EMEA: Europe, Middle East, Africa',
    APAC: 'üåè APAC: Asia Pacific (Asia + Oceania)'
  };

const SERVICE_LABEL = {
    fullCapabilityHub: [
      'AV Manufacturing',  
      'AV After Sales',
                'AV Spares Support',
      'AV Disposals'
    ],
    otherServiceLocations: 'Other Service Locations',
    
    supportCenter: [
         'AV Service Support',
        'AV Spares Support',
      'AV Disposals'
    ]
};

  // GraphQL: serviceRange -> services
  const QUERY = `
    query {
      serviceNetworks(stage: PUBLISHED, first: 1000, orderBy: updatedAt_DESC) {
        id name country region hubID serviceRange phone email
        location { latitude longitude }
        updatedAt
        image { url }
      }
    }`;

  // ====== MAP INIT ======
  mapboxgl.accessToken = MAPBOX_TOKEN;
  const map = new mapboxgl.Map({
    container:'map',
    style:'mapbox://styles/mapbox/streets-v12',
    center:[25.0,15.0],
    zoom:2.5
  });
  map.addControl(new mapboxgl.NavigationControl());

  // ====== DOM ======
  const regionPills   = document.getElementById('regionFilterPills')
  const locateBtn     = document.getElementById('locateMe');
  
let currentRegionFilter = '';

  // ====== STATE ======
  let allCenters = [];
let currentGeo = null;
let geoMarker = null;


// üé® NEW CODE: Icon Mapping and Loading
// ====== ICON LOADING ======
const ICON_MAP = {
  fullCapabilityHub: 'manufacturing-icon', // Icon ID for Manufacturing Facility
  supportCenter: 'support-icon'           // Icon ID for Regional Hub
};

// üí° PASTE YOUR BASE64 STRINGS HERE üí°
// REPLACE THE PLACEHOLDERS BELOW with the actual Base64 strings you generated
const MANUFACTURING_BASE64 = "data:image/png;base64,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"; 
const SUPPORT_BASE64 = "data:image/png;base64,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";


// Function to load all necessary icons before the map layer is created
function loadMapIcons() {
    return new Promise((resolve, reject) => {
        const iconsToLoad = [
            { path: MANUFACTURING_BASE64, id: ICON_MAP.fullCapabilityHub },
            { path: SUPPORT_BASE64, id: ICON_MAP.supportCenter }
        ];

        let loadedCount = 0;
        const totalIcons = iconsToLoad.length;

        if (totalIcons === 0) {
            resolve();
            return;
        }

        iconsToLoad.forEach(icon => {
            // Note: The map.loadImage now accepts the Base64 string directly
            map.loadImage(icon.path, (error, image) => {
                if (error) {
                    console.error(`Error loading icon ${icon.id}:`, error);
                } else {
                    if (!map.hasImage(icon.id)) {
                        map.addImage(icon.id, image);
                    }
                }
                loadedCount++;
                if (loadedCount === totalIcons) {
                    resolve();
                }
            });
        });
    });
}
// --------------------------
// --------------------------


  // ====== FETCH ======
  async function fetchCenters(){
    const res = await fetch(HYGRAPH_ENDPOINT, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      cache:'no-store',
      body: JSON.stringify({ query: QUERY })
    });
    const json = await res.json();
    if (!json.data) {
      console.error('Hygraph error:', json.errors || json);
      return [];
    }
    const list = (json.data.serviceNetworks || []).filter(c => c.location);
    // normalize keys to match SERVICE_LABEL usage
    return list.map(c => ({
      ...c,
      services: c.serviceRange
    }));
  }

function buildRegionPills(list){
    // 1. Define the custom order for the region codes (AMER, EMEA, APAC)
    const CUSTOM_REGION_ORDER = ['AMER', 'EMEA', 'APAC'];

    const regions = [...new Set(list.map(c => c.region).filter(Boolean))]
      // 2. Use the custom order to sort the regions
      .sort((a, b) => CUSTOM_REGION_ORDER.indexOf(a) - CUSTOM_REGION_ORDER.indexOf(b));
    
    // Start with the 'Global' button (value is "")
    let html = `<button class="filter-pill active" data-region="">üåê Global</button>`;
    
    // Add buttons for each unique region
    html += regions.map(r => 
        // üõ†Ô∏è CORRECTED LINE: Use REGION_LABEL[r] for the display text
        `<button class="filter-pill" data-region="${r}">${REGION_LABEL[r] || r}</button>`
    ).join('');

    regionPills.innerHTML = html;

    // Add click listener to the container
    regionPills.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn || btn.classList.contains('active')) return;

        // Set the new filter value
        currentRegionFilter = btn.getAttribute('data-region');
        
        // Update active state
        document.querySelectorAll('#regionFilterPills .filter-pill').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        applyFiltersAndRender();
    });
}
  // ====== HELPERS ======
  function toGeoJSON(list){
    return {
      type:'FeatureCollection',
      features: list.map(c => ({
        type:'Feature',
        properties:{
          id: c.id,
          name: c.name,
          country: c.country || '',
          region: c.region || '',
          hubID: c.hubID || '',
          phone: c.phone || '',
          email: c.email || '',
          serviceKey: c.services || '',
          logo: (c.image && c.image.url) || ''
        },
        geometry:{ type:'Point', coordinates:[c.location.longitude, c.location.latitude] }
      }))
    };
  }

  const normalizePhone = s => (s||'').replace(/[^\d]/g,''); // keep digits for wa.me

function popupHTML(p, lat, lng){
  const isFC = p.serviceKey === 'fullCapabilityHub';

  // Helper function to create contact HTML block (can be reused)
  const createContactHTML = (p) => {
    const whatsappMsg = encodeURIComponent(
      `Hub ID: ${p.hubID || 'N/A'} | Support Request\n\n` +
      `Good day,\n\n` +
      `I am contacting regarding:\n`
    );

    const CENTRAL_WA = '971527118654';
    const waNumber = normalizePhone(p.phone) || CENTRAL_WA;

    const whatsappIcon = '<img src="wa.png" alt="WhatsApp" style="width:14px;height:14px;margin-left:4px;vertical-align:middle">';
    const mailIcon = '<img src="mail.png" alt="Email" style="width:14px;height:14px;margin-left:4px;vertical-align:middle">';

    const phoneHTML = waNumber
      ? `<a target="_blank" rel="noopener" href="https://wa.me/${waNumber}?text=${whatsappMsg}">${whatsappIcon}WhatsApp</a>`
      : '';

    const emailAddr = p.email || 'support@mahindraarmored.com';
    const emailHTML = `<a href="mailto:${emailAddr}">${mailIcon}Email</a>`;

    return `
      <div class="contact-buttons">
        ${phoneHTML}
        ${emailHTML}
      </div>
    `;
  };

  // Helper function to create Service Range HTML block (can be reused)
 // Add isFC as an argument so the function knows the hub type
// Function is defined to accept the 'isFC' flag
const createServiceHTML = (p, isFC) => {
    const serviceData = SERVICE_LABEL[p.serviceKey] || p.serviceKey || '';

    // CONDITIONAL HEADING LOGIC:
    // If isFC is true (Full-Capability Hub), headingHTML is empty ('').
    // If isFC is false (Regional Support Hub), the heading is included.
    const headingHTML = isFC
        ? '' 
        : '<p><strong>üß∞ Service Range:</strong></p>'; 

    let serviceHTML;
    if (Array.isArray(serviceData)) {
        // If it's an array, create an unordered list (bullet points)
        serviceHTML = `
            <ul style="padding-left: 20px; margin-top: 5px; list-style-type: disc; color: #4b5563;">
                ${serviceData.map(item => `<li style="margin-bottom: 4px; line-height: 1.3;">${item}</li>`).join('')}
            </ul>
        `;
    } else {
        // Otherwise, render as a single paragraph
        const serviceText = String(serviceData).trim();
        serviceHTML = `<p style="margin-top:10px;text-align:justify;">${serviceText || '‚Äî'}</p>`;
    }

    return `
        <div class="service-range">
            ${headingHTML}  ${serviceHTML}
        </div>
    `;
};
// ----------------------------------------------------------------------
// --- START: Separate HTML for Full-Capability Hub (isFC = true) ---
// ----------------------------------------------------------------------

  if (isFC) {
  const logoHTML = p.logo
  ? `<div style="text-align: center; padding-top: 10px; margin-bottom: 10px;">
       <div style="
         display: inline-flex;
         align-items: center;
         justify-content: center;
         width: 60px;
         height: 60px;
         border-radius: 50%;
         background-color: #E6E6E6;
         overflow: hidden;
         margin: 0 auto 5px auto;
         box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
       ">
         <img src="${p.logo}" alt="${p.name} logo" style="
           width: 100%;
           height: 100%;
           object-fit: contain; /* üîπ ensures full logo visible */
           object-position: center; /* üîπ centers the logo */
           display: block;
         ">
       </div>
     </div>`
  : '';


    return `
      <div class="popup full-capability">
        
        ${logoHTML}
<div style="background-color: #FCFCFC; ">
          <p><strong><span style="color:#E41837;">End-to-End</p><p>Armoured Vehicle Services</span></strong></p>
        

        ${createServiceHTML(p, isFC)}
        ${createContactHTML(p)}

        </div>
        <div class="popup-footer"></div>
      </div>
    `;
  }

// ----------------------------------------------------------------------
// --- ELSE: HTML for Regional Support Hub (isFC = false) ---
// ----------------------------------------------------------------------

  else { // Regional Support Hub
    // 1. Generate logoHTML with the centering wrapper
  const logoHTML = p.logo
        ? `<div style="text-align: center; padding-top: 10px; margin-bottom: 10px;">
             <div style="
               display: inline-flex;
               align-items: center;
               justify-content: center;
               width: 60px;
               height: 60px;
               border-radius: 50%;
               background-color: #E6E6E6; /* Optional: background color for the circle */
               overflow: hidden;           /* Crucial: hides parts of image that go outside the circle */
               margin: 0 auto 5px auto;
box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
             ">
               <img src="${p.logo}" alt="${p.name} logo" style="
                 width: 100%;             /* Make image take full width of container */
                 height: 100%;            /* Make image take full height of container */
                 object-fit: cover;       /* CRUCIAL: Makes image fill the circle, cropping if necessary */
                 display: block;
               ">
             </div>
           </div>`
        : '';

    return `
      <div class="popup regional-support">
        
        
        ${logoHTML}
        <div style="background-color: #Ffffff; padding: 10px; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);">
          <p><strong>Regional Support Hub - <span style="color:#E41837;">${p.country || '‚Äî'}</span></strong></p>
        </div>
        
         

        ${createServiceHTML(p, isFC)}
        ${createContactHTML(p)}

        <div style="background-color: #F1F1f1; padding-top: 10px; padding-bottom: 10px; text-align: center;box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);">
          <p style="margin-bottom: 8px;"><strong>HUB ID</strong></p>
          <p>
            <strong><span class="hub-id-badge">${p.hubID || ''}</strong>
          </p>
        </div>
        <div class="popup-footer"></div>
      </div>
    `;
}
}


  // ====== FILTER + RENDER ======
function applyFiltersAndRender(){
    // Remove the old user location marker if it exists (THIS IS CORRECT)
    if (geoMarker) {
        geoMarker.remove();
        geoMarker = null; // Clear the reference
    }

    // Use a single, correct declaration for filtering
    const r = currentRegionFilter;
    const filtered = allCenters.filter(c => !r || c.region === r);

    currentGeo = toGeoJSON(filtered);
    const src = map.getSource('svc');
    if (src) {
      src.setData(currentGeo);
    } else {
      map.addSource('svc', { type:'geojson', data: currentGeo, cluster:false });
      
      // üé® UPDATED: Changed layer type from 'circle' to 'symbol' and added responsive icon logic
      map.addLayer({
        id:'points',
        type:'symbol', // ‚¨ÖÔ∏è CHANGED: Use 'symbol' for custom icons
        source:'svc',
        layout:{
          'icon-image': [ // ‚¨ÖÔ∏è NEW: Use 'icon-image' property
            'case', 
            ['==', ['get', 'serviceKey'], 'fullCapabilityHub'],
            ICON_MAP.fullCapabilityHub, // Manufacturing Icon ID
            ICON_MAP.supportCenter      // Support Hub Icon ID (default)
          ],
          'icon-allow-overlap': true,
          'icon-ignore-placement': true,
          // ‚¨ÖÔ∏è NEW: Responsive icon size based on zoom level
          'icon-size': [
    'interpolate', 
    ['linear'], 
    ['zoom'],
    3, 0.4, // Still 40% at zoom 3
    9, 1.0, // Still 100% at zoom 9
    12, 2.0 // üöÄ NEW: Now 200% (double the size) at zoom 12 and above
]
        }
        // NOTE: The 'paint' object for 'circle' is now removed
      });

      map.on('click','points', (e) => {
        const f = e.features[0];
        const p = f.properties;
        const [lng,lat] = f.geometry.coordinates;
        new mapboxgl.Popup().setLngLat([lng,lat]).setHTML(popupHTML(p, lat, lng)).addTo(map);
      });
      map.on('mouseenter','points', () => map.getCanvas().style.cursor = 'pointer');
      map.on('mouseleave','points', () => map.getCanvas().style.cursor = '');
    }

    if (filtered.length > 0) {
      const bounds = new mapboxgl.LngLatBounds();
      filtered.forEach(c => c.location && bounds.extend([c.location.longitude, c.location.latitude]));
      try {
        map.fitBounds(bounds, { padding:50, maxZoom:6 });
      } catch {}
    } else {
      map.flyTo({ center:[20,10], zoom:2 });
    }
}
// üöÄ NEW: MAPBOX GEOCODER INTEGRATION
// ===================================

// 1. Initialize the Mapbox Geocoder control
const geocoder = new MapboxGeocoder({
    accessToken: MAPBOX_TOKEN, // Uses the existing defined token
    mapboxgl: mapboxgl,
    marker: false, // Prevents the geocoder from dropping its own marker
    placeholder: 'Search for a Country or City',
    // Set proximity to your main area of interest for slightly better results
    proximity: {
        longitude: 25.0,
        latitude: 15.0
    }
});

// 2. Mount the Geocoder into the new container
// This line tells the Geocoder to draw itself inside the HTML element.
document.getElementById('geocoder-container').appendChild(geocoder.onAdd(map));

// 3. Listen for a successful search result
geocoder.on('result', (e) => {
    // When a user searches a location, reset the region filter to 'Global'
    currentRegionFilter = '';
    
    // Visually reset the pills: Deactivate all, Activate 'Global'
    document.querySelectorAll('#regionFilterPills .filter-pill').forEach(b => b.classList.remove('active'));
    const globalPill = document.querySelector('#regionFilterPills [data-region=""]');
    if (globalPill) {
        globalPill.classList.add('active');
    }
    
    // ‚ùå REMOVED: We no longer call applyFiltersAndRender(). 
    // The Geocoder automatically handles the map movement (flyTo), and we 
    // only want to reset the UI, not force a map data re-render that might 
    // zoom the map back out to the full 'Global' bounds.
});
// ------------------------------------

// ====== EVENTS ======
¬†¬†
¬† locateBtn.onclick = () => {
    
    // 1. Reset the filter state to show all regions (Global)
    currentRegionFilter = '';

    // 2. Visually reset the pills: Deactivate all, Activate 'Global'
    document.querySelectorAll('#regionFilterPills .filter-pill').forEach(b => b.classList.remove('active'));
    const globalPill = document.querySelector('#regionFilterPills [data-region=""]');
    if (globalPill) {
        globalPill.classList.add('active');
    }

    // 3. Re-render the map to ensure all centers are displayed globally
    applyFiltersAndRender();

¬† ¬† if (!navigator.geolocation) return alert('Geolocation not supported');
¬† ¬†¬†
¬† ¬† // Remove existing marker before finding location again
¬† ¬† if (geoMarker) {
¬† ¬† ¬† ¬† geoMarker.remove();
¬† ¬† ¬† ¬† geoMarker = null;
¬† ¬† }

¬† ¬† navigator.geolocation.getCurrentPosition(pos=>{
¬† ¬† ¬† const { latitude, longitude } = pos.coords;
¬† ¬† ¬† map.flyTo({ center:[longitude, latitude], zoom:6 });
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† // Assign the new marker to geoMarker
¬† ¬† ¬† geoMarker = new mapboxgl.Marker({color:'#1f2937'})
¬† ¬† ¬† ¬† ¬† .setLngLat([longitude, latitude])
¬† ¬† ¬† ¬† ¬† .addTo(map);

¬† ¬† }, err => {
¬† ¬† ¬† console.warn(err);
¬† ¬† ¬† alert('Could not get your location.');
¬† ¬† }, { enableHighAccuracy:true, timeout:10000 });
¬† };

 // üöÄ UPDATED BOOT SEQUENCE: Load icons before rendering the layer
(async () => {
  allCenters = await fetchCenters();
  buildRegionPills(allCenters);

  // Wait for the map to load its basic tiles/style
  await new Promise(resolve => {
    if (map.loaded()) {
      resolve();
    } else {
      map.on('load', resolve);
    }
  });

  // 1. Wait for custom icons to load and be added to the style
  await loadMapIcons(); 

  // 2. Render the map layer using the new icons
  applyFiltersAndRender(); 
})();

  </script>
</body>
</html>


