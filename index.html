<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mahindra Armored ‚Äî Service Network</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Georama:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    html,body,#map{height:100%;margin:0}
    body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .panel{
      position:absolute;top:10px;left:10px;z-index:2;background:#fff;
      padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.12);
      font: clamp(12px, 1.4vw, 16px)/1.4 inherit;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;max-width:450px;
    }
    .panel label{display:flex;gap:6px;align-items:center}
    .panel select,.panel button{padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px;background:#fff}
    .panel button{cursor:pointer}
    .k{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:6px;vertical-align:middle}
    .legend-item.red{background-color:#e41837;border:1px solid #e41837}
    .legend-item.white{background-color:#ffffff;border:1px solid #e41837}
    .mapboxgl-popup-content{padding:10px;max-width:min(90vw,420px)}
    .popup h3{margin:0 0 4px;font-size:clamp(14px,1.5vw,18px)}
    .popup p{margin:0;font-size:clamp(12px,1.3vw,14px);line-height:1.35;overflow-wrap:anywhere}
    .popup-footer{
      margin-top:10px;height:3px;background:#e11d48;border-radius:2px;
    }
  </style>
</head>
<body>
  <div class="panel" aria-label="Map controls">
    <label>Region:
      <select id="regionFilter" aria-label="Filter by region">
        <option value="">All</option>
      </select>
    </label>
    <button id="locateMe" aria-label="Use my location">üìç Use My Location</button>
    <button id="refreshBtn" aria-label="Refresh data">‚Üª Refresh</button>
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; width:100%;">
      <div><span class="k legend-item red"></span> AV Manufacturing Facility</div>
      <div><span class="k legend-item white"></span> Regional Support Hubs</div>
    </div>
  </div>

  <div id="map" role="region" aria-label="Global Service Network"></div>

  <script>
  // ====== CONFIG ======
  const MAPBOX_TOKEN = 'pk.eyJ1IjoibnJhanBrIiwiYSI6ImNtZnFoejJhaDBua2cybHM4dHRtZ2xycW4ifQ.wAJkzxTCQiRmIZuSyW59Uw';
  const HYGRAPH_ENDPOINT = 'https://ap-south-1.cdn.hygraph.com/content/cmfpk332g005s08uylh0ezd8a/master';

  const REGION_LABEL = {
    AMER: 'AMER ‚Üí North & Latin America',
    EMEA: 'EMEA ‚Üí Europe, Middle East, Africa',
    APAC: 'APAC ‚Üí Asia Pacific (Asia + Oceania)'
  };

  const SERVICE_LABEL = {
    fullCapabilityHub: 'Full-Capability Hub',
    otherServiceLocations: 'Other Service Locations',
    supportCenter: 'Armoured Vehicle - Maintenance, HD Spares & More'
  };

  // GraphQL: serviceRange -> services
  const QUERY = `
    query {
      serviceNetworks(stage: PUBLISHED, first: 1000, orderBy: updatedAt_DESC) {
        id name country region hubID serviceRange phone email
        location { latitude longitude }
        updatedAt
        image { url }
      }
    }`;

  // ====== MAP INIT ======
  mapboxgl.accessToken = MAPBOX_TOKEN;
  const map = new mapboxgl.Map({
    container:'map',
    style:'mapbox://styles/mapbox/streets-v12',
    center:[25.0,15.0],
    zoom:2.5
  });
  map.addControl(new mapboxgl.NavigationControl());

  // ====== DOM ======
  const regionSelect  = document.getElementById('regionFilter');
  const locateBtn     = document.getElementById('locateMe');
  const refreshBtn    = document.getElementById('refreshBtn');

  // ====== STATE ======
  let allCenters = [];
  let currentGeo = null;

  // ====== FETCH ======
  async function fetchCenters(){
    const res = await fetch(HYGRAPH_ENDPOINT, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      cache:'no-store',
      body: JSON.stringify({ query: QUERY })
    });
    const json = await res.json();
    if (!json.data) {
      console.error('Hygraph error:', json.errors || json);
      return [];
    }
    const list = (json.data.serviceNetworks || []).filter(c => c.location);
    // normalize keys to match SERVICE_LABEL usage
    return list.map(c => ({
      ...c,
      services: c.serviceRange
    }));
  }

  // ====== FILTER UI BUILD ======
  function buildRegionFilter(list){
    const regions = [...new Set(list.map(c => c.region).filter(Boolean))]
      .sort((a,b) => (REGION_LABEL[a]||a).localeCompare(REGION_LABEL[b]||b));
    regionSelect.innerHTML = '<option value="">All</option>' +
      regions.map(r => `<option value="${r}">${REGION_LABEL[r] || r}</option>`).join('');
  }

  // ====== HELPERS ======
  function toGeoJSON(list){
    return {
      type:'FeatureCollection',
      features: list.map(c => ({
        type:'Feature',
        properties:{
          id: c.id,
          name: c.name,
          country: c.country || '',
          region: c.region || '',
          hubID: c.hubID || '',
          phone: c.phone || '',
          email: c.email || '',
          serviceKey: c.services || '',
          logo: (c.image && c.image.url) || ''
        },
        geometry:{ type:'Point', coordinates:[c.location.longitude, c.location.latitude] }
      }))
    };
  }

  const normalizePhone = s => (s||'').replace(/[^\d]/g,''); // keep digits for wa.me

  function popupHTML(p, lat, lng){
    const regionText  = (REGION_LABEL[p.region] || p.region || '').trim();
    const serviceText = (SERVICE_LABEL[p.serviceKey] || p.serviceKey || '').trim();

    const whatsappMsg = encodeURIComponent(
      `Hub ID: ${p.hubID || 'N/A'} | Support Request\n\n` +
      `Good day,\n\n` +
      `I am contacting regarding:\n`
    );

    // If you want central number, set CENTRAL_WA = '971527118654' and use it below
    const CENTRAL_WA = '971527118654';
    const waNumber = normalizePhone(p.phone) || CENTRAL_WA;

    const whatsappIcon = '<img src="wa.png" alt="WhatsApp" style="width:14px;height:14px;margin-left:4px;vertical-align:middle">';
    const mailIcon = '<img src="mail.png" alt="Email" style="width:14px;height:14px;margin-left:4px;vertical-align:middle">';

    const phoneHTML = waNumber
      ? `<a target="_blank" rel="noopener" href="https://wa.me/${waNumber}?text=${whatsappMsg}">${whatsappIcon} Connect on WhatsApp</a>`
      : '';

    const emailAddr = p.email || 'support@mahindraarmored.com';
    const emailHTML = `<a href="mailto:${emailAddr}">${mailIcon} Send Requirement Mail</a>`;

    const isFC = p.serviceKey === 'fullCapabilityHub';
    const logoHTML = p.logo
      ? (isFC
          ? `<div style="text-align:center;padding-top:10px;margin-bottom:8px;">
               <img src="${p.logo}" alt="${p.name} logo" style="max-width:180px;height:auto;display:inline-block">
             </div>`
          : `<img src="${p.logo}" alt="${p.name} logo" style="max-width:25px;max-height:60px;display:block;margin-bottom:10px">`)
      : '';

    return `
      <div class="popup" style="font-family:'Georama', sans-serif;">
        ${logoHTML}
        <h3>${p.hubID || ''}</h3>
        <p><strong>${p.name || '‚Äî'}</strong></p>
        <p style="margin-top:10px;"><strong>Region:</strong> ${regionText} (${p.country || '‚Äî'})</p>
        <p style="margin-top:10px;text-align:justify;"><strong>Service Range:</strong> ${serviceText || '‚Äî'}</p>
        <br>
        <p>${phoneHTML || '‚Äî'}</p><br>
        <p>${emailHTML}</p>
        <div class="popup-footer"></div>
      </div>`;
  }

  // ====== FILTER + RENDER ======
  function applyFiltersAndRender(){
    const r = regionSelect.value;
    const filtered = allCenters.filter(c => !r || c.region === r);

    currentGeo = toGeoJSON(filtered);
    const src = map.getSource('svc');
    if (src) {
      src.setData(currentGeo);
    } else {
      map.addSource('svc', { type:'geojson', data: currentGeo, cluster:false });
      map.addLayer({
        id:'points',
        type:'circle',
        source:'svc',
        paint:{
          'circle-radius': [
            'case', ['==',['get','serviceKey'],'fullCapabilityHub'],
            7, 4
          ],
          'circle-color': [
            'case', ['==',['get','serviceKey'],'fullCapabilityHub'],
            '#e41837', '#ffffff'
          ],
          'circle-stroke-width': [
            'case', ['==',['get','serviceKey'],'fullCapabilityHub'],
            1, 3
          ],
          'circle-stroke-color': [
            'case', ['==',['get','serviceKey'],'fullCapabilityHub'],
            '#ffffff', '#e41837'
          ]
        }
      });
      map.on('click','points', (e) => {
        const f = e.features[0];
        const p = f.properties;
        const [lng,lat] = f.geometry.coordinates;
        new mapboxgl.Popup().setLngLat([lng,lat]).setHTML(popupHTML(p, lat, lng)).addTo(map);
      });
      map.on('mouseenter','points', () => map.getCanvas().style.cursor = 'pointer');
      map.on('mouseleave','points', () => map.getCanvas().style.cursor = '');
    }

    if (filtered.length > 0) {
      const bounds = new mapboxgl.LngLatBounds();
      filtered.forEach(c => c.location && bounds.extend([c.location.longitude, c.location.latitude]));
      try {
        map.fitBounds(bounds, { padding:50, maxZoom:6 });
      } catch {}
    } else {
      map.flyTo({ center:[20,10], zoom:2 });
    }
  }

  // ====== REFRESH LOGIC ======
  async function refreshData({ rebuildRegion=false } = {}){
    const prevRegion = regionSelect.value;
    allCenters = await fetchCenters();
    if (rebuildRegion) buildRegionFilter(allCenters);
    regionSelect.value = prevRegion || '';
    applyFiltersAndRender();
  }

  // ====== EVENTS ======
  regionSelect.onchange = applyFiltersAndRender;

  locateBtn.onclick = () => {
    if (!navigator.geolocation) return alert('Geolocation not supported');
    navigator.geolocation.getCurrentPosition(pos=>{
      const { latitude, longitude } = pos.coords;
      map.flyTo({ center:[longitude, latitude], zoom:6 });
      new mapboxgl.Marker({color:'#1f2937'}).setLngLat([longitude, latitude]).addTo(map);
    }, err => {
      console.warn(err);
      alert('Could not get your location.');
    }, { enableHighAccuracy:true, timeout:10000 });
  };

  refreshBtn.onclick = () => refreshData({ rebuildRegion:true });

  let refreshTimer = setInterval(() => refreshData(), 60000);
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) refreshData();
  });

  // ====== BOOT ======
  // ====== BOOT ======
(async () => {
  allCenters = await fetchCenters();
  buildRegionFilter(allCenters);

  if (map.loaded()) {
    applyFiltersAndRender();
  } else {
    map.on('load', applyFiltersAndRender);
  }
})();

  </script>
</body>
</html>

