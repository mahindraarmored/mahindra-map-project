<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mahindra Armored ‚Äî Service Network</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Georama:wght@400;500;600&display=swap" rel="stylesheet">

<style>
    html,body,#map{height:100%;margin:0}
    .panel{
      position:absolute;top:10px;left:10px;z-index:2;background:#fff;
      padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.12);
      font: clamp(12px, 1.4vw, 16px)/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      max-width: 450px;
    }
    .panel label{display:flex;gap:6px;align-items:center}
    .panel select,.panel button{padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px;background:#fff}
    .panel button{cursor:pointer}
    .legend{
      position:absolute;bottom:10px;left:10px;z-index:2;background:#fff;padding:8px 10px;border-radius:8px;
      box-shadow:0 6px 18px rgba(0,0,0,.12);
      font: clamp(11px, 1.3vw, 15px)/1.3 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .k{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:6px;vertical-align:middle}
    .legend-item.red {
        background-color: #e41837;
        border: 1px solid #e41837;
    }
    .legend-item.white {
        background-color: #ffffff;
        border: 1px solid #e41837;
    }
    .popup h3 {
      margin: 0 0 4px;
      font-size: clamp(14px, 1.5vw, 18px);
    }
    .popup p {
      margin: 0;
      font-size: clamp(12px, 1.3vw, 14px);
      line-height: 1.35;
      word-break: break-all;
    }
    .mapboxgl-popup-content {
      padding: 10px;
      max-width: 250px;
 	
    }
  </style>

 <style>
    .mapboxgl-popup-content { max-width: min(90vw, 420px); }

    .popup-footer { 
  text-align: center;
  margin-top: 10px; 
  padding-top: 0;        /* no extra padding */
  border-top: none;      /* remove grey line */
}

.popup-footer {
  margin-top: 10px;
  height: 3px;
  background: #e11d48; /* red */
  border-radius: 2px;
}

  </style>
</head>
<body>
  <div class="panel">
    <label>Region:
      <select id="regionFilter">
        <option value="">All</option>
      </select>
    </label>
    <button id="locateMe">üìç Use My Location</button>
    <button id="refreshBtn">‚Üª Refresh</button>
    <div style="display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; width: 100%;">
      <div><span class="k legend-item red"></span> AV Manufacturing Facility</div>
      <div><span class="k legend-item white"></span> Regional Support Hubs</div>
    </div>
  </div>

  <div id="map" role="region" aria-label="Global Service Network"></div>

  <script>
  // ====== CONFIG ======
  const MAPBOX_TOKEN = 'pk.eyJ1IjoibnJhanBrIiwiYSI6ImNtZnFoejJhaDBua2cybHM4dHRtZ2xycW4ifQ.wAJkzxTCQiRmIZuSyW59Uw';
  const HYGRAPH_ENDPOINT = 'https://api-ap-south-1.hygraph.com/v2/cmfpk332g005s08uylh0ezd8a/master';

  const REGION_LABEL = {
    AMER: 'AMER ‚Üí North & Latin America',
    EMEA: 'EMEA ‚Üí Europe, Middle East, Africa',
    APAC: 'APAC ‚Üí Asia Pacific (Asia + Oceania)'
  };

  const SERVICE_LABEL = {
    'fullCapabilityHub': 'Full-Capability Hub',
    'otherServiceLocations': 'Other Service Locations',
    'supportCenter': ' Armoured Vehicle - Maintenance, HD Spares & More'
  };

  // ====== GQL QUERY ======
  const QUERY = `
  query {
    serviceNetworks(stage: PUBLISHED, first: 1000, orderBy: updatedAt_DESC) {
      id name country region hubID services: serviceRange phone email
      location { latitude longitude }
      updatedAt
      image { url }
    }
  }`;


  // ====== MAP INIT ======
  mapboxgl.accessToken = MAPBOX_TOKEN;
  const map = new mapboxgl.Map({
    container:'map',
    style:'mapbox://styles/mapbox/streets-v12',
    center:[25.0, 15.0],
    zoom:2.5
  });
  map.addControl(new mapboxgl.NavigationControl());

  // ====== DOM ======
  const regionSelect  = document.getElementById('regionFilter');
  const locateBtn     = document.getElementById('locateMe');
  const refreshBtn    = document.getElementById('refreshBtn');

  // ====== STATE ======
  let allCenters = [];
  let currentGeo = null;

  // ====== FETCH ======
  async function fetchCenters(){
    const res = await fetch(HYGRAPH_ENDPOINT, {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Cache-Control':'no-cache'
      },
      cache:'no-store',
      body: JSON.stringify({ query: QUERY })
    });
    const json = await res.json();
    if (!json.data) {
      console.error('Hygraph error:', json.errors || json);
      return [];
    }
    return (json.data.serviceNetworks || []).filter(c => c.location);
  }

  // ====== FILTER UI BUILD (Regions only) ======
  function buildRegionFilter(list){
    const regions = [...new Set(list.map(c => c.region).filter(Boolean))].sort();
    regionSelect.innerHTML = '<option value="">All</option>' +
      regions.map(r => `<option value="${r}">${REGION_LABEL[r] || r}</option>`).join('');
  }

  // ====== HELPERS ======
  function toGeoJSON(list){
    return {
      type:'FeatureCollection',
      features: list.map(c => ({
        type:'Feature',
        properties: {
  id: c.id,
  name: c.name,
  country: c.country || '',
  region: c.region || '',
  hubID: c.hubID || '',            // ‚úÖ added
  phone: c.phone || '',
  email: c.email || '',
  serviceKey: c.services || '',
  logo: c.image?.url || ''
},

        geometry:{ type:'Point', coordinates:[c.location.longitude, c.location.latitude] }
      }))
    };
  }

function popupHTML(p, lat, lng){
  const regionText  = (REGION_LABEL[p.region] || p.region || '').trim();
  const serviceText = (SERVICE_LABEL[p.serviceKey] || p.serviceKey || '').trim();
  
  // Custom WhatsApp Message (Final Version)
  const whatsappMsg = encodeURIComponent(
    `Good day,\n` + 
    `I'd like to raise a support request in ${p.region || 'N/A'} region\n\n` +
    `Support Hub ID: ${p.hubID || 'N/A'}\n\n` +
    `My requirement is*:\n` +
    `Vehicle Model (*optional*):\n` +
    `Armouring Level (*optional*):`
  );
  
  // Define the WhatsApp icon HTML
  const whatsappIcon = '<img src="wa.png" alt="WhatsApp Icon" style="width: 14px; height: 14px; margin-left: 4px; vertical-align: middle;">';
const mailIcon = '<img src="mail.png" alt="WhatsApp Icon" style="width: 14px; height: 14px; margin-left: 4px; vertical-align: middle;">';

	
  // CHANGE 1 (Revised): WhatsApp link with pre-filled message and new icon
  const phoneHTML   = p.phone 
    ? `<a target="_blank" href="https://wa.me/${p.phone.replace(/\D/g, '')}?text=${whatsappMsg}">${whatsappIcon} Connect on Whatsapp </a>`  : '';
  
	
  // CHANGE 2: "Send Requirement Mail" replaces the email link
  const emailHTML   = p.email ? `<a href="mailto:${p.email}">${mailIcon} Send Requirement Mail </a>` : '';
  
  const isFC = p.serviceKey === 'fullCapabilityHub';

  // hero image for Full-Capability hubs (full width, ‚Äúbleeds‚Äù to popup edges),
  // small thumb for others; hides if there is no image.
let logoHTML = '';
if (p.logo) {
  if (isFC) {
    // Full-capability hub ‚Üí large full-width logo
    logoHTML = `
      <div style="text-align:center; padding-top:10px; margin-bottom:8px;">
        <img src="${p.logo}" alt="${p.name} logo"
             style="max-width:180px; height:auto; display:inline-block;">
      </div>`;
  } else {
    // Other hubs ‚Üí small thumbnail logo
    logoHTML = `
      <img src="${p.logo}" alt="${p.name} logo"
           style="max-width:25px;max-height:60px;display:block;margin-bottom:10px;">`;
  }
}

 return `
  <div class="popup" style="font-family: 'Georama', sans-serif;">
    ${logoHTML}
    <h3>${p.hubID || ''}</h3>
    <p><strong>${p.name || '‚Äî'}</strong></p>

	<p style="margin-top:10px;"><strong>Region:</strong> ${p.region || '‚Äî'} (${p.country || '‚Äî'})</p>

    
    <p style="margin-top:10px; text-align: justify;"><strong>Service Range:</strong> ${serviceText || '‚Äî'}</p>

    <br>
    <p>${phoneHTML || '‚Äî'}</p> <br>
    <p>${emailHTML || '‚Äî'}</p>
    
    <div class="popup-footer"></div>
  </div>`;
}


  // ====== FILTER + RENDER (Region only) ======
  function applyFiltersAndRender(){
    const r = regionSelect.value;
    const filtered = allCenters.filter(c => {
      const okR = !r || c.region === r;
      return okR;
    });

    currentGeo = toGeoJSON(filtered);
    const src = map.getSource('svc');
    if (src) {
      src.setData(currentGeo);
    } else {
      map.addSource('svc', { type:'geojson', data: currentGeo, cluster:false });
      map.addLayer({ id:'clusters', type:'circle', source:'svc',
        filter:['has','point_count'],
        paint:{ 'circle-radius':['step',['get','point_count'],16,10,22,30,30] } });
      map.addLayer({ id:'cluster-count', type:'symbol', source:'svc',
        filter:['has','point_count'],
        layout:{ 'text-field':['get','point_count_abbreviated'], 'text-size':12 } });
      map.addLayer({
        id:'points',
        type:'circle',
        source:'svc',
        filter:['!',['has','point_count']],
        paint: {
  // Set circle radius based on serviceKey
  'circle-radius': [
    'case',
    ['==', ['get', 'serviceKey'], 'fullCapabilityHub'],
    7, // Radius 7 for 'fullCapabilityHub'
    4  // Radius 4 for all other values
  ],
  
  // Set circle fill color based on serviceKey
  'circle-color': [
    'case',
    ['==', ['get', 'serviceKey'], 'fullCapabilityHub'],
    '#e41837', // Red for 'fullCapabilityHub'
    '#ffffff'  // White for all other values
  ],
  
  // Set stroke width based on serviceKey
  'circle-stroke-width': [
    'case',
    ['==', ['get', 'serviceKey'], 'fullCapabilityHub'],
    1, // Stroke width 1 for 'fullCapabilityHub'
    3  // Stroke width 3 for all other values
  ],
  
  // Set stroke color based on serviceKey
  'circle-stroke-color': [
    'case',
    ['==', ['get', 'serviceKey'], 'fullCapabilityHub'],
    '#ffffff', // White for 'fullCapabilityHub'
    '#e41837'  // Red for all other values
  ]
}
      });
      map.on('click','points', (e) => {
        const f = e.features[0];
        const p = f.properties;
        const [lng,lat] = f.geometry.coordinates;
        new mapboxgl.Popup().setLngLat([lng,lat]).setHTML(popupHTML(p, lat, lng)).addTo(map);
      });
      map.on('click','clusters', (e) => {
        const feats = map.queryRenderedFeatures(e.point, { layers:['clusters'] });
        const clusterId = feats[0].properties.cluster_id;
        map.getSource('svc').getClusterExpansionZoom(clusterId, (err, zoom) => {
          if (err) return;
          map.easeTo({ center: feats[0].geometry.coordinates, zoom });
        });
      });
    }

    if (filtered.length > 0) {
      const bounds = new mapboxgl.LngLatBounds();
      filtered.forEach(center => {
        if (center.location) {
          bounds.extend([center.location.longitude, center.location.latitude]);
        }
      });

      map.fitBounds(bounds, {
        padding: 50,
        maxZoom: 6
      });
    } else {
      map.flyTo({ center: [20, 10], zoom: 2 });
    }
  }

  // ====== REFRESH LOGIC ======
  async function refreshData({rebuildRegion=false} = {}){
    const prevRegion = regionSelect.value;
    allCenters = await fetchCenters();
    if (rebuildRegion) buildRegionFilter(allCenters);
    regionSelect.value = prevRegion || '';
    applyFiltersAndRender();
  }

  // ====== EVENTS ======
  regionSelect.onchange  = applyFiltersAndRender;

  locateBtn.onclick = () => {
    if (!navigator.geolocation) return alert('Geolocation not supported');
    navigator.geolocation.getCurrentPosition(pos=>{
      const { latitude, longitude } = pos.coords;
      map.flyTo({ center:[longitude, latitude], zoom: 6 });
      new mapboxgl.Marker({color:'#1f2937'}).setLngLat([longitude, latitude]).addTo(map);
    });
  };

  refreshBtn.onclick = () => refreshData({rebuildRegion:true});
  setInterval(() => refreshData(), 60000);
  document.addEventListener('visibilitychange', () => { if (!document.hidden) refreshData(); });

  // ====== BOOT ======
  (async () => {
    allCenters = await fetchCenters();
    buildRegionFilter(allCenters);
    
    map.on('load', applyFiltersAndRender);
  })();
  </script>
</body>
</html>




