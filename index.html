<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mahindra Emirates Vehicle Armouring - Global Support Network</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Mapbox CSS/JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

  <!-- Geocoder CSS/JS -->
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Georama:wght@400;500;600&display=swap" rel="stylesheet">

<style>
/* -----------------------------------------------------------
 * 1. ROOT VARIABLES & GENERAL SETUP
 * ----------------------------------------------------------- */
html, body, #map { height: 100%; margin: 0; }
body { 
    font-family: "Georama", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; 
    overflow-x: hidden; 
}

:root{
    /* Primary Control Dimensions (Search/Reset Button) */
    --ctrl-h: clamp(38px, 4.2vw, 46px);
    --ctrl-pad-x: clamp(10px, 1.2vw, 16px);
    --ctrl-radius: 9999px;
    --ctrl-fs: clamp(12px, 1.1vw, 15px);
    --input-fs: clamp(14px, 1.2vw, 16px);
    --icon-left: 14px;

    /* Chip Dimensions (Filter/Legend Chips) */
    --chip-h: calc(var(--ctrl-h) * 0.75);
    --chip-fs: clamp(12px, 1.1vw, 14px);

    /* Estimated Max Height of the Top Panel (Used for positioning other elements) */
    --top-panel-max-h: 140px; 
}

/* -----------------------------------------------------------
 * 2. TOP PANEL (Search & Chips)
 * ----------------------------------------------------------- */
.panel{
    position:absolute; top:10px; z-index:2; 
    left: 14px; 
    transform: none; 
    width: min(400px, 90vw); 
    padding: 10px 14px 0 14px; 
    border-radius: 12px;
    display:flex; flex-direction:column; gap:0; 
}

/* Search and Reset Button Row */
#search-and-controls-group{
    display:flex;
    align-items:center;
    gap:10px;
    width: 100%;
    padding-bottom: 10px; 
}

/* Geocoder */
#geocoder-container{ flex: 1 1 auto; min-width:0; }
#geocoder-container .mapboxgl-ctrl-geocoder{
    width:100% !important; height:var(--ctrl-h); min-height:var(--ctrl-h);
    border-radius:var(--ctrl-radius); border:1px solid #d0d0d0; background:#fff;
    box-shadow:none; 
}
#geocoder-container .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--input{
    height:calc(var(--ctrl-h) - 2px); line-height:calc(var(--ctrl-h) - 2px);
    font-size:var(--input-fs); box-sizing:border-box;
    padding:0 var(--ctrl-pad-x) 0 calc(var(--icon-left) + 24px);
}
#geocoder-container .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--icon{
    left:var(--icon-left); top:50%; transform:translateY(-50%);
}

/* Reset button */
#resetMapBtn{
    flex-shrink: 0; width: var(--ctrl-h); height:var(--ctrl-h); 
    border-radius:var(--ctrl-radius); border:1px solid #d0d0d0; background:#fff;
    box-shadow:none; display:inline-flex; align-items:center; justify-content:center;
    font-weight:600; font-size:var(--ctrl-fs); line-height:1;
    cursor:pointer; user-select:none; padding: 0; 
    transition:background-color .15s ease, color .15s ease, border-color .15s ease;
}
@media (min-width: 720px){
    #resetMapBtn:hover{ background:#f0f0f0; }
}

/* Chip Scroll Row (Container for Region Filters) */
#chip-scroll-row {
    display: flex;
    overflow-x: auto; 
    -webkit-overflow-scrolling: touch; 
    white-space: nowrap; 
    margin: 0 -14px; 
    padding: 0 14px 14px 14px; 
    scrollbar-width: none;
}
#chip-scroll-row::-webkit-scrollbar { display: none; }

/* Region Chip Container */
#regionChips{
    display:flex; gap:8px;
    flex: none; 
    flex-wrap: nowrap; 
    justify-content: flex-start;
    align-items: flex-start;
}

/* Individual Region Chip */
.region-chip{
    flex-shrink: 0; 
    height:var(--chip-h);
    padding:0 var(--ctrl-pad-x);
    font-size:var(--chip-fs); 
    border-radius:var(--ctrl-radius); 
    border:1px solid #d0d0d0; background:#fff;
    box-shadow:0 1px 2px rgba(0,0,0,.06);
    display:inline-flex; align-items:center; justify-content:center;
    line-height:1; cursor:pointer; user-select:none;
    transition:background-color .15s ease, color .15s ease, border-color .15s ease, box-shadow .15s ease;
}
.region-chip:hover{ background:#f0f0f0;; border-color:#f0f0f0; }
.region-chip.active{ background:#e41837; color:#fff; border-color:#e41837; }


/* -----------------------------------------------------------
 * 3. LEGEND (Toggle Button and Modal)
 * ----------------------------------------------------------- */

/* Mapbox Controls and Popups */
.mapboxgl-popup-content{ padding:10px; max-width:min(90vw, 420px); padding-bottom:12px; }
.popup h3{ margin:0 0 4px; font-size:clamp(14px,1.5vw,18px); }
.popup p{ margin:0; font-size:clamp(12px,1.3vw,14px); line-height:1.35; overflow-wrap:anywhere; }
.contact-buttons{ display:flex; gap:10px; margin-top:12px; margin-bottom:10px; justify-content:center; padding-bottom:10px; }
.contact-buttons a{
    display:inline-block; padding:6px 10px; border-radius:9999px; text-decoration:none;
    font-weight:700; background:#fff; color:#E41837; border:1px solid #E41837;
    transition:background-color .2s, color .2s, border-color .2s;
}
.contact-buttons a:hover{ background:#E41837; color:#fff; }

/* Mapbox controls: put attribution bottom-left */
.mapboxgl-ctrl-bottom-left{
    position:absolute; left:14px; bottom:14px; display:flex !important; flex-direction:column-reverse !important; gap:6px;
}
.mapboxgl-ctrl-bottom-left .mapboxgl-ctrl-attrib{ order:2; margin:0 !important; background:none; padding:2px 6px; font-size:11px; }
.mapboxgl-ctrl-bottom-left .mapboxgl-ctrl-scale{ display:none !important; }
.mapboxgl-ctrl-bottom-right .mapboxgl-ctrl-group {
    margin-bottom: 10px;
    box-shadow: 0 1px 2px rgba(0,0,0,.06);
}

/* Toggle Button Icon Styles */
.legend-toggle-container .mapboxgl-ctrl-icon {
    width: 29px; height: 29px; padding: 2px;
}

/* Individual Legend Chip Style (shared between mobile/desktop) */
.legend-chip {
    flex-shrink: 0; height: var(--chip-h);
    padding: 0 var(--ctrl-pad-x); font-size: var(--chip-fs); 
    border-radius: var(--ctrl-radius); border: 1px solid #d0d0d0; background: #fff;
    box-shadow: 0 1px 2px rgba(0,0,0,.06);
    display: inline-flex; align-items: center; justify-content: center;
    gap: 6px; line-height: 1; user-select: none;
}
.legend-chip img {
    width: calc(var(--chip-h) * 0.7);
    height: calc(var(--chip-h) * 0.7);
    object-fit: contain; flex-shrink: 0;
}


/* -----------------------------------------------------------
 * 5. MEDIA QUERIES (Responsiveness)
 * ----------------------------------------------------------- */

/* CONSOLIDATED MOBILE STYLES (max-width: 599px)
   All mobile-specific positioning and pop-up logic is contained here. */
@media (max-width: 599px) {
    /* Panel Centering (from previous 420px rule) */
    .panel {
        /* Center the panel on the screen */
        left: 50% !important;
        transform: translateX(-50%) !important;
        width: 96vw;
    }

    /* 1. Legend Toggle Button (Mobile Only) - Positioned bottom-left */
    .legend-toggle-container {
        /* Ensures the button is visible on mobile */
        display: block !important; 
        position: absolute;
        bottom: 45px; 
        left: 10px; 
        right: auto;
        z-index: 20; 
    }

    /* 2. Legend Modal (Mobile Pop-up) - Control-style Pop-up from Left-Bottom */
    .legend-modal {
        position: absolute;
        /* Position the modal just above the toggle button */
        bottom: 80px; 
        left: 10px;
        
        /* Give it a fixed size, similar to a standard map control box */
        width: 240px;
        max-width: 90vw;
        
        z-index: 10; 
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        padding: 12px; 
        
        display: flex;
        flex-direction: column;
        gap: 8px; 
        
        /* Use opacity/visibility for a smooth fade-in/out (inherited by .not(.hidden)) */
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
    }
    .legend-modal:not(.hidden) {
        opacity: 1;
        visibility: visible;
    }
    
    /* Header is visible on mobile pop-up */
    .legend-modal-header {
        /* Ensures the header is displayed, overriding the desktop 'display: none' */
        display: flex !important;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px; 
    }

    /* Mobile chips should still be full width for readability */
    .legend-modal .legend-chip {
        width: 100%;
    }
}


/* Tablet / Desktop (>= 600px): Legend Fixes and Desktop Layout */
@media (min-width: 600px) {
    /* 1. Hide the mobile toggle button on desktop */
    .legend-toggle-container {
        display: none !important;
    }

    /* 2. Style the modal back into a stack of chips (Desktop View) */
    .legend-modal {
        position: absolute;
        top: auto;
        bottom: 50px; 
        left: 14px;
        right: auto;
        
        /* FIX FOR DESKTOP OVERLAP: Use a simpler, relative max-height calculation. */
        max-height: calc(100vh - var(--top-panel-max-h) - 100px); 
        
        /* Reset display to a simple vertical grid */
        width: auto;
        background-color: transparent;
        box-shadow: none;
        padding: 0;
        display: grid;
        gap: 8px;
        
        /* Ensure it's always visible */
        transform: none !important; 
        transition: none !important;

        /* Forced visibility for desktop permanent display */
        opacity: 1 !important;
        visibility: visible !important;
    }
    
    /* 3. Hide the header/close button on large screens */
    .legend-modal-header {
        display: none !important;
    }
    
    /* Ensure the chips maintain their desktop style (no 100% width) */
    .legend-modal .legend-chip {
        width: auto;
    }
}
 
</style>


</head>
<body>

<div class="panel" aria-label="Search and Filters">
  <div id="search-and-controls-group"> 
    <div id="geocoder-container"></div>
    <button id="resetMapBtn" title="Reset map">‚ü≤</button> 
  </div>
  <div id="chip-scroll-row"> 
    <div id="regionChips" aria-label="Regions"></div>
  </div>
</div>

<div id="map" role="region" aria-label="Global Service Network"></div>

<div class="mapboxgl-ctrl mapboxgl-ctrl-group legend-toggle-container">
  <button id="legendToggleBtn" class="mapboxgl-ctrl-icon" aria-label="Show Legend" title="Show Legend">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
  </button>
</div>

<div id="legend-modal" class="legend-modal hidden">
  <div class="legend-modal-header">
    <h4>Legend</h4>
    <button id="closeLegendBtn" aria-label="Close Legend">&times;</button>
  </div>
  <div class="legend-chip">
    <img id="legend-icon-mfg" alt="Full Capability Hub Icon">
    <span>Armoured Vehicle: Full Capability Hub</span>
  </div> <!-- Corrected closing tag -->
  <div class="legend-chip">
    <img id="legend-icon-support" alt="Support Center Icon">
    <span>Armoured Vehicle: Regional Support Hub</span>
  </div>
</div>

  <script>
   



    const REGION_LABEL = {
      AMER: 'üåé AMER: North & Latin America',
      EMEA: 'üåç EMEA: Europe, Middle East, Africa',
      APAC: 'üåè APAC: Asia Pacific (Asia + Oceania)'
    };
    const GLOBAL_TITLE = 'View All Regions Worldwide';

    const SERVICE_LABEL = {
      fullCapabilityHub: [ 'AV Manufacturing', 'AV After Sales', 'AV Spares Support', 'AV Disposals' ],
      otherServiceLocations: 'Other Service Locations',
      supportCenter: [ 'AV Service Support', 'AV Spares Support', 'AV Disposals' ]
    };

    // GraphQL query
    const QUERY = `
      query {
        serviceNetworks(stage: PUBLISHED, first: 1000, orderBy: updatedAt_DESC) {
          id name country region hubID serviceRange phone email
          location { latitude longitude }
          updatedAt
          image { url }
        }
      }`;




    // ===== MAP INIT =====
    mapboxgl.accessToken = MAPBOX_TOKEN;
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [25.0, 15.0],
      zoom: 2.5
    });

// === ‚¨áÔ∏è ADD THIS CODE ‚¨áÔ∏è ===

    // 1. Add Zoom (Navigation) control
    // This adds zoom in, zoom out, and a compass
    const navControl = new mapboxgl.NavigationControl();
    map.addControl(navControl, 'bottom-right');
    
    // 2. Add "Locate Me" (Geolocate) control
    const geolocateControl = new mapboxgl.GeolocateControl({
      positionOptions: {
        enableHighAccuracy: true
      },
      trackUserLocation: true, // Continuously update location
      showUserHeading: true    // Show direction user is facing
    });
    map.addControl(geolocateControl, 'bottom-right');
    
    // === ‚¨ÜÔ∏è END OF NEW CODE ‚¨ÜÔ∏è ===



    
    const INITIAL_MAP_CENTER = map.getCenter();
    const INITIAL_MAP_ZOOM = map.getZoom();

    // Simple symbol icons (base64) ‚Äî no external files required
    const ICON_MAP = {
      fullCapabilityHub: 'manufacturing-icon',
      supportCenter: 'support-icon'
    };





// New constant for the Email SVG
const EMAIL_SVG = `
  <svg viewBox="0 0 1920 1920" xmlns="http://www.w3.org/2000/svg" style="width:24px; height:24px; display:block;" fill="#3a88fe">
    <path d="M1920 428.266v1189.54l-464.16-580.146-88.203 70.585 468.679 585.904H83.684l468.679-585.904-88.202-70.585L0 1617.805V428.265l959.944 832.441L1920 428.266ZM1919.932 226v52.627l-959.943 832.44L.045 278.628V226h1919.887Z" fill-rule="evenodd"></path>
  </svg>
`;

// Existing constant for the WhatsApp SVG (for completeness)
const WHATSAPP_SVG = `
  <svg viewBox="0 0 48 48" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="width:24px; height:24px; display:block;" fill="currentColor">
    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
      <g transform="translate(-700.000000, -360.000000)" fill="#25D366">
        <path d="M723.993033,360 C710.762252,360 700,370.765287 700,383.999801 C700,389.248451 701.692661,394.116025 704.570026,398.066947 L701.579605,406.983798 L710.804449,404.035539 C714.598605,406.546975 719.126434,408 724.006967,408 C737.237748,408 748,397.234315 748,384.000199 C748,370.765685 737.237748,360.000398 724.006967,360.000398 L723.993033,360.000398 L723.993033,360 Z M717.29285,372.190836 C716.827488,371.07628 716.474784,371.034071 715.769774,371.005401 C715.529728,370.991464 715.262214,370.977527 714.96564,370.977527 C714.04845,370.977527 713.089462,371.245514 712.511043,371.838033 C711.806033,372.557577 710.056843,374.23638 710.056843,377.679202 C710.056843,381.122023 712.567571,384.451756 712.905944,384.917648 C713.258648,385.382743 717.800808,392.55031 724.853297,395.471492 C730.368379,397.757149 732.00491,397.545307 733.260074,397.27732 C735.093658,396.882308 737.393002,395.527239 737.971421,393.891043 C738.54984,392.25405 738.54984,390.857171 738.380255,390.560912 C738.211068,390.264652 737.745308,390.095816 737.040298,389.742615 C736.335288,389.389811 732.90737,387.696673 732.25849,387.470894 C731.623543,387.231179 731.017259,387.315995 730.537963,387.99333 C729.860819,388.938653 729.198006,389.89831 728.661785,390.476494 C728.238619,390.928051 727.547144,390.984595 726.969123,390.744481 C726.193254,390.420348 724.021298,389.657798 721.340985,387.273388 C719.267356,385.42535 717.856938,383.125756 717.448104,382.434484 C717.038871,381.729275 717.405907,381.319529 717.729948,380.938852 C718.082653,380.501232 718.421026,380.191036 718.77373,379.781688 C719.126434,379.372738 719.323884,379.160897 719.549599,378.681068 C719.789645,378.215575 719.62006,377.735746 719.450874,377.382942 C719.281687,377.030139 717.871269,373.587317 717.29285,372.190836 Z" id="Whatsapp"> </path>
      </g>
    </g>
  </svg>
`;

// A small Blue Square (representing Manufacturing)
const MANUFACTURING_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAALElEQVR42mNkYPhfzcDAwMgABX9FGBkYGBmIApM1AC7BUIBDPWpA9v8fMwMAl7YID6Y6+6sAAAAASUVORK5CYII=';

// A small Red Square (representing Support)
const SUPPORT_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAALElEQVR42mP8z8BwAIyZGBgYGBmIApM1AC7BUIBDPWpA9v8fMwMAl7YID6Y6+6sAAAAASUVORK5CYII=';

    function loadMapIcons(){
      return new Promise((resolve) => {
        const icons = [
          { id: ICON_MAP.fullCapabilityHub, path: MANUFACTURING_BASE64 },
          { id: ICON_MAP.supportCenter, path: SUPPORT_BASE64 }
        ];
        let loaded = 0;
        icons.forEach(({id, path}) => {
          map.loadImage(path, (err, img) => {
            if (!err && img && !map.hasImage(id)) map.addImage(id, img);
            loaded++; if (loaded === icons.length) resolve();
          });
        });
      });
    }

    // ===== DATA =====
    async function fetchCenters(){
      const res = await fetch(HYGRAPH_ENDPOINT, {
        method:'POST', headers:{ 'Content-Type':'application/json' }, cache:'no-store',
        body: JSON.stringify({ query: QUERY })
      });
      const json = await res.json();
      if (!json.data) { console.error('Hygraph error:', json.errors || json); return []; }
      const list = (json.data.serviceNetworks || []).filter(c => c.location);
      return list.map(c => ({
        id: c.id,
        name: c.name,
        country: c.country || '',
        region: c.region || '',
        hubID: c.hubID || '',
        phone: c.phone || '',
        email: c.email || '',
        services: c.serviceRange,
        logo: (c.image && c.image.url) || '',
        location: { lat: c.location.latitude, lng: c.location.longitude }
      }));
    }

    const SERVICE_ICON_MAP = {
      'AV Manufacturing': 'üè≠',
      'AV After Sales': '‚öôÔ∏è',
      'AV Spares Support': 'üß∞',
      'AV Disposals': '‚ôªÔ∏è',
      'AV Service Support': 'üõ†Ô∏è'
    };

    const normalizePhone = s => (s||'').replace(/[^\d]/g,'');

    function getServiceIconsHTML(p){
      const data = SERVICE_LABEL[p.serviceKey];
      const items = Array.isArray(data) ? data : (data ? [data] : []);
      return items.map(label => SERVICE_ICON_MAP[label] || '').filter(Boolean)
        .map(sym => `<span title="${sym}" aria-hidden="true">${sym}</span>`).join('');
    }



function hoverHTML(p){
  const isFC = p.serviceKey === 'fullCapabilityHub';
  const sub = isFC ? 'Full Capability Hub' : 'Regional Service Hub';
  const CENTRAL_WA = '971527118654';
  const waNumber = normalizePhone(p.phone) || CENTRAL_WA;
  const whatsappMsg = encodeURIComponent(`Hub ID: ${p.hubID || 'N/A'} | Support Request`);
  const waHref = `https://wa.me/${waNumber}?text=${whatsappMsg}`;
  const mailHref = `mailto:${p.email || 'support@mahindraarmored.com'}`;
  
  // NOTE: For better visual spacing, I've increased the badge size to 40px
  // and ensured the icons inside are 20px.
  const BADGE_SIZE = '40px'; 
  const ICON_SIZE = '20px';

  // We modify the SVG constants to include the new size for consistency:
  const WHATSAPP_SVG_20PX = WHATSAPP_SVG.replace('width:24px; height:24px;', `width:${ICON_SIZE}; height:${ICON_SIZE};`);
  const EMAIL_SVG_20PX = EMAIL_SVG.replace('width:24px; height:24px;', `width:${ICON_SIZE}; height:${ICON_SIZE};`);
  
  return `
    <div class="hover-card" style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:start;">
      <div class="info">
        <div class="title" style="font-weight:700;">${p.country || ''}</div>
        <div class="subtitle" style="font-size:13px;color:#555;">${sub}</div>
        <div class="svc-icons" style="display:flex;gap:8px;margin-top:4px;">${getServiceIconsHTML(p)}</div>
      </div>
      <div class="actions" style="display:grid;gap:6px;justify-items:end;">
        <a class="badge" href="${waHref}" target="_blank" rel="noopener" title="WhatsApp" 
           style="display:inline-flex;align-items:center;justify-content:center;width:${BADGE_SIZE};height:${BADGE_SIZE};border:1px solid rgba(0,0,0,.12);border-radius:6px;">
          ${WHATSAPP_SVG_20PX}
        </a>
        <a class="badge" href="${mailHref}" title="Email" 
           style="display:inline-flex;align-items:center;justify-content:center;width:${BADGE_SIZE};height:${BADGE_SIZE};border:1px solid rgba(0,0,0,.12);border-radius:6px;">
          ${EMAIL_SVG_20PX}
        </a>
      </div>
    </div>`;
}
    function popupHTML(p){
      const isFC = p.serviceKey === 'fullCapabilityHub';
      const CENTRAL_WA = '971527118654';
      const waNumber = normalizePhone(p.phone) || CENTRAL_WA;
      const waHref = `https://wa.me/${waNumber}?text=${encodeURIComponent('Hub ID: ' + (p.hubID||'N/A'))}`;
      const mailHref = `mailto:${p.email || 'support@mahindraarmored.com'}`;

      const serviceData = SERVICE_LABEL[p.serviceKey] || p.serviceKey || '';
      const serviceHTML = Array.isArray(serviceData)
        ? `<ul style="padding-left:20px;margin-top:6px;list-style:disc;color:#4b5563;">${serviceData.map(i=>`<li>${i}</li>`).join('')}</ul>`
        : `<p style="margin-top:6px;">${String(serviceData || '‚Äî')}</p>`;

      const title = isFC
        ? '<strong><span style="color:#E41837;">Full Capability Hub</span> AV Production & Services</strong>'
        : `<strong>Regional Support Hub ‚Äî <span style="color:#E41837;">${p.country || '‚Äî'}</span></strong>`;

      // üîÑ RE-INTEGRATED LOGO LOGIC
      const logoHTML = p.logo
        ? `<div style="text-align: center; padding-top: 10px; margin-bottom: 10px;">
              <div style="
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background-color: #E6E6E6;
                overflow: hidden;
                margin: 0 auto 5px auto;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
              ">
                <img src="${p.logo}" alt="${p.name} logo" style="
                  width: 100%;
                  height: 100%;
                  object-fit: contain;
                  object-position: center;
                  display: block;
                ">
              </div>
            </div>`
        : '';

      return `
        <div class="popup full-capability">
          ${logoHTML}
          <p>${title}</p>
          ${serviceHTML}
          <div class="contact-buttons">
            <a href="${waHref}" target="_blank" rel="noopener">WhatsApp</a>
            <a href="${mailHref}">Email</a>
          </div>
          ${!isFC ? `<div style="background:#f3f4f6;padding:8px;border-radius:6px;text-align:center;margin-top:6px;">HUB ID: <strong>${p.hubID || ''}</strong></div>` : ''}
        </div>`;
    }

    // ===== STATE =====
    let allCenters = [];
    let currentRegionFilter = '';
    let hoverPopup = null, hoverCloseTimer = null, detailOpen = false, lastHoverId = null;

    function cleanupHover(){
      if (hoverCloseTimer){ clearTimeout(hoverCloseTimer); hoverCloseTimer = null; }
      if (hoverPopup){ hoverPopup.remove(); hoverPopup = null; }
      lastHoverId = null; map.getCanvas().style.cursor = '';
    }

    ['dragstart','zoomstart','movestart','styledata'].forEach(ev => map.on(ev, cleanupHover));

    function toGeoJSON(list){
      return {
        type: 'FeatureCollection',
        features: list.map(c => ({
          type: 'Feature',
          properties: {
            id: c.id, name: c.name, country: c.country, region: c.region,
            hubID: c.hubID, phone: c.phone, email: c.email, serviceKey: c.services, logo: c.logo
          },
          geometry: { type: 'Point', coordinates: [c.location.lng, c.location.lat] }
        }))
      };
    }

    function buildRegionChips(list){
      const container = document.getElementById('regionChips');
      const order = ['AMER','EMEA','APAC'];
      const regions = [...new Set(list.map(c=>c.region).filter(Boolean))].sort((a,b)=>order.indexOf(a)-order.indexOf(b));
      
      // *** MODIFIED LINE HERE ***
      // We are directly building the chips array from 'regions', skipping the hardcoded 'Global' chip.
      const chips = regions.map(code => ({ 
        code, 
        label:(REGION_LABEL[code]||code).split(':')[0].trim(), 
        title: REGION_LABEL[code]||code 
      }));
      // *** END MODIFICATION ***
      
      container.innerHTML = chips.map(({code,label,title}) => `
        <button class="region-chip${code===currentRegionFilter?' active':''}" data-region="${code}" title="${title}">${label}</button>
      `).join('');
      container.onclick = e => {
        const btn = e.target.closest('.region-chip'); if (!btn) return;
        const code = btn.getAttribute('data-region')||''; 
        // NOTE: The 'code' will never be '' now, so the next line is safe.
        if (currentRegionFilter===code) return;
        currentRegionFilter = code; container.querySelectorAll('.region-chip').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
        applyFiltersAndRender();
      };
    }

function applyFiltersAndRender(){
      const r = currentRegionFilter;
      const inBounds = allCenters.filter(c => !r || c.region === r);

      const src = map.getSource('svc');
      if (!src){
        map.addSource('svc', { type:'geojson', data: toGeoJSON(allCenters), cluster: false });
        map.addLayer({
          id:'points', type:'symbol', source:'svc',
          layout:{
            'icon-image': [ 'case', ['==',['get','serviceKey'],'fullCapabilityHub'], ICON_MAP.fullCapabilityHub, ICON_MAP.supportCenter ],
            'icon-allow-overlap': true,
            'icon-ignore-placement': true,
            'icon-size': ['interpolate', ['linear'], ['zoom'], 3, 0.024, 9, 0.061, 12, 0.121]  // Smaller Support icon
          }
        });

        // Click popup (detail)
        map.on('click','points',(e)=>{
          cleanupHover(); detailOpen = true;
          const f = e.features[0];
          new mapboxgl.Popup({ closeOnMove: true })
            .setLngLat(f.geometry.coordinates)
            .setHTML(popupHTML(f.properties))
            .addTo(map)
            .on('close', ()=>{ detailOpen = false; });
        });

        // Always enable hover handlers (no touch guard)
        map.on('mouseenter','points',(e)=>{
          if (detailOpen) return;
          map.getCanvas().style.cursor = 'pointer';
          const f = e.features[0]; const p = f.properties; const id = f.id || p.id || JSON.stringify(p);
          if (!hoverPopup){
            hoverPopup = new mapboxgl.Popup({ closeButton:false, closeOnClick:false, offset:14, className:'hover-popup' })
              .setLngLat(f.geometry.coordinates)
              .setHTML(hoverHTML(p))
              .addTo(map);
            lastHoverId = id;
            const el = hoverPopup.getElement();
            el.addEventListener('mouseenter', ()=>{ if (hoverCloseTimer){ clearTimeout(hoverCloseTimer); hoverCloseTimer=null; } });
            el.addEventListener('mouseleave', ()=>{ hoverCloseTimer = setTimeout(()=>cleanupHover(), 150); });
          }
        });
        map.on('mousemove','points',(e)=>{
          if (!hoverPopup) return;
          const f = e.features && e.features[0]; if (!f) return;
          const p = f.properties; const id = f.id || p.id || JSON.stringify(p);
          if (id !== lastHoverId){ hoverPopup.setHTML(hoverHTML(p)); lastHoverId = id; }
          hoverPopup.setLngLat(f.geometry.coordinates);
        });
        map.on('mouseleave','points',()=>{ hoverCloseTimer = setTimeout(()=>cleanupHover(), 120); });
      }

      // Fly to bounds of filtered set
      if (inBounds.length){
        const b = new mapboxgl.LngLatBounds();
        inBounds.forEach(c=>b.extend([c.location.lng, c.location.lat]));
        try{ map.fitBounds(b, { padding:50, maxZoom:6 }); }catch{}
      } else {
        map.flyTo({ center:[20,10], zoom:2 });
      }
    }

    // Geocoder (countries only)
    const geocoder = new MapboxGeocoder({ accessToken: MAPBOX_TOKEN, mapboxgl, marker:false, placeholder:'Search MEVA Hubs', proximity:{ longitude:25, latitude:15 } });
    geocoder.on('results', (res) => {
      if (res && Array.isArray(res.features)) {
        res.features = res.features.filter(f => Array.isArray(f.place_type) && f.place_type.includes('country'));
      }
    });
    document.getElementById('geocoder-container').appendChild(geocoder.onAdd(map));

   // Reset
document.getElementById('resetMapBtn').onclick = ()=>{
    currentRegionFilter = '';
    
    // üîë KEY CHANGE: Add this line to clear the geocoder input field
    geocoder.clear(); 
    
    document.querySelectorAll('#regionChips .region-chip').forEach(b=>b.classList.remove('active'));
    const globalBtn = document.querySelector('#regionChips .region-chip[data-region=""]'); if (globalBtn) globalBtn.classList.add('active');
    applyFiltersAndRender();
    map.flyTo({ center: INITIAL_MAP_CENTER, zoom: INITIAL_MAP_ZOOM, bearing:0, pitch:0, essential:true });
};

   


(async ()=>{
      await new Promise(res => map.on('load', res));
      await loadMapIcons();

      // ‚¨áÔ∏è UPDATED CODE TO POPULATE THE LEGEND ICONS ‚¨áÔ∏è
      try {
        // This targets the <img> tags inside your new #legend-modal
        document.getElementById('legend-icon-mfg').src = MANUFACTURING_BASE64;
        document.getElementById('legend-icon-support').src = SUPPORT_BASE64;
      } catch (e) {
        console.warn("Could not set legend icons.", e);
        
        // If icons fail, hide the toggle button to prevent an empty modal
        const toggleContainer = document.querySelector('.legend-toggle-container');
        if (toggleContainer) toggleContainer.style.display = 'none';
      }
      // ‚¨ÜÔ∏è END OF NEW CODE ‚¨ÜÔ∏è

      allCenters = await fetchCenters();
      buildRegionChips(allCenters);
      applyFiltersAndRender();

      // Debug helpers (optional):
      console.log('centers:', allCenters.length);
      console.log('touch-detected:', ('ontouchstart' in window) || navigator.maxTouchPoints > 0);
    })();
  </script>
  <script src="sidebar.js"></script>
</body>
</html>




