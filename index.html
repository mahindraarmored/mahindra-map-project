<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mahindra Armored ‚Äî Service Network (Working)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Mapbox CSS/JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

  <!-- Geocoder CSS/JS -->
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Georama:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
  html, body, #map { height: 100%; margin: 0; }
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; overflow-x: hidden; }

  /* Panel */
  .panel{
    position:absolute; top:10px; left:10px; z-index:2; right:auto;
    min-width:360px; max-width:420px; max-height:calc(100% - 20px);
    padding:14px; border-radius:12px; background:transparent; display:flex; flex-direction:column; gap:10px;
    font-family:"Georama", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  }

  :root{
    --ctrl-h: clamp(38px, 4.2vw, 46px);
    --ctrl-pad-x: clamp(10px, 1.2vw, 16px);
    --ctrl-radius: 9999px;
    --ctrl-fs: clamp(12px, 1.1vw, 15px);
    --input-fs: clamp(14px, 1.2vw, 16px);
    --icon-left: 14px;
  }

  /* MODIFIED: Stack elements vertically */
  #search-and-toggle-group{
    display:flex;
    flex-direction: column; /* KEY CHANGE */
    align-items:center;
    gap:10px;
    width: 100%; /* Ensure it spans the panel width */
  }

  /* MODIFIED: Ensure geocoder container is full width */
  #geocoder-container{
    flex: none; /* KEY CHANGE: Removed flex:1 1 auto */
    width: 100%; /* KEY CHANGE */
    min-width:0;
  }
  #geocoder-container .mapboxgl-ctrl-geocoder{
    display:flex; align-items:center;
  width:100% !important; /* IMPORTANT: Override Mapbox's default inline or computed width */
  height:var(--ctrl-h); min-height:var(--ctrl-h);
  border-radius:var(--ctrl-radius); border:1px solid #d0d0d0; background:#fff;
  box-shadow:0 1px 2px rgba(0,0,0,.06);
}
  #geocoder-container .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--input{
    height:calc(var(--ctrl-h) - 2px);
    line-height:calc(var(--ctrl-h) - 2px);
    font-size:var(--input-fs);
    padding:0 var(--ctrl-pad-x) 0 calc(var(--icon-left) + 24px);
    box-sizing:border-box;
  }
  #geocoder-container .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--icon{
    left:var(--icon-left); top:50%; transform:translateY(-50%);
  }

  /* MODIFIED: Ensure right button group is full width */
  #right-button-group{
    display:flex;
    align-items:center;
    gap:10px;
    width: 100%; /* KEY CHANGE */
  }

  #regionChips{ flex:1 1 auto; display:flex; gap:8px; flex-wrap: wrap; /* <--- KEY CHANGE: Allow chips to wrap to new lines */
    justify-content: center; } /* Added flex:1 1 auto to let chips take space */
  .region-chip{
    height:var(--ctrl-h); padding:0 var(--ctrl-pad-x);
    border-radius:var(--ctrl-radius); border:1px solid #d0d0d0; background:#fff;
    box-shadow:0 1px 2px rgba(0,0,0,.06);
     align-items:center; justify-content:center;
    font-size:var(--ctrl-fs); line-height:1; cursor:pointer; user-select:none;
    transition:background-color .15s ease, color .15s ease, border-color .15s ease, box-shadow .15s ease;
  }
  .region-chip:hover{ background:#ee5b71; border-color:#ee5b71; }
  .region-chip.active{ background:#e41837; color:#fff; border-color:#e41837; }

  /* Responsive oval reset button */
  #resetMapBtn{
    flex-shrink: 0; /* Prevents button from shrinking */
    height:var(--ctrl-h); padding:0 1.2em; width:auto;
    border-radius:9999px; border:1px solid #d0d0d0; background:#fff;
    box-shadow:0 1px 2px rgba(0,0,0,.06);
    display:inline-flex; align-items:center; justify-content:center;
    font-weight:600; font-size:var(--ctrl-fs); line-height:1;
    cursor:pointer; user-select:none;
    transition:background-color .15s ease, color .15s ease, border-color .15s ease, box-shadow .15s ease;
  }
  #resetMapBtn:hover{ background:#000000; }

  /* Popup styles */
  .mapboxgl-popup-content{ padding:10px; max-width:min(90vw, 420px); padding-bottom:12px; }
  .popup h3{ margin:0 0 4px; font-size:clamp(14px,1.5vw,18px); }
  .popup p{ margin:0; font-size:clamp(12px,1.3vw,14px); line-height:1.35; overflow-wrap:anywhere; }
  .contact-buttons{ display:flex; gap:10px; margin-top:12px; margin-bottom:10px; justify-content:center; padding-bottom:10px; }
  .contact-buttons a{
    display:inline-block; padding:6px 10px; border-radius:9999px; text-decoration:none;
    font-weight:700; background:#fff; color:#E41837; border:1px solid #E41837;
    transition:background-color .2s, color .2s, border-color .2s;
  }
  .contact-buttons a:hover{ background:#E41837; color:#fff; }

  /* Mapbox controls: put attribution bottom-left */
  .mapboxgl-ctrl-bottom-left{
    position:absolute; left:14px; bottom:14px; display:flex !important; flex-direction:column-reverse !important; gap:6px;
  }
  .mapboxgl-ctrl-bottom-left .mapboxgl-ctrl-attrib{ order:2; margin:0 !important; background:none; padding:2px 6px; font-size:11px; }
  .mapboxgl-ctrl-bottom-left .mapboxgl-ctrl-scale{ display:none !important; }

  @media (max-width: 420px) {
  /* This rule applies ONLY when the screen is 420px wide or narrower (mobile) */
  .panel {
    /* Override the original left:10px and right:auto; */
    left: 50% !important;
    right: auto !important;
    /* Center the panel by shifting it back by half its own width */
    transform: translateX(-50%) !important;
  }
}

  .mapboxgl-ctrl-bottom-right .mapboxgl-ctrl-group {
    margin-bottom: 10px;
    box-shadow: 0 1px 2px rgba(0,0,0,.06);
  }
  
  
  
  
  
  </style>
</head>
<body>

  <div class="panel" aria-label="Search and Filters">
    <div class="panel" aria-label="Search and Filters">
  <div id="search-and-toggle-group">
    <div id="geocoder-container"></div>
    <div id="right-button-group"> <div id="regionChips" aria-label="Regions"></div> <button id="resetMapBtn" title="Reset map">‚ü≤</button> </div>
  </div>
</div>
  </div>

  <div id="map" role="region" aria-label="Global Service Network"></div>

  <script>
    // ===== CONFIG =====
    const MAPBOX_TOKEN = 'pk.eyJ1IjoibnJhanBrIiwiYSI6ImNtZnFoejJhaDBua2cybHM4dHRtZ2xycW4ifQ.wAJkzxTCQiRmIZuSyW59Uw';
    const HYGRAPH_ENDPOINT = 'https://ap-south-1.cdn.hygraph.com/content/cmfpk332g005s08uylh0ezd8a/master';

    const REGION_LABEL = {
      AMER: 'üåé AMER: North & Latin America',
      EMEA: 'üåç EMEA: Europe, Middle East, Africa',
      APAC: 'üåè APAC: Asia Pacific (Asia + Oceania)'
    };
    const GLOBAL_TITLE = 'View All Regions Worldwide';

    const SERVICE_LABEL = {
      fullCapabilityHub: [ 'AV Manufacturing', 'AV After Sales', 'AV Spares Support', 'AV Disposals' ],
      otherServiceLocations: 'Other Service Locations',
      supportCenter: [ 'AV Service Support', 'AV Spares Support', 'AV Disposals' ]
    };

    // GraphQL query
    const QUERY = `
      query {
        serviceNetworks(stage: PUBLISHED, first: 1000, orderBy: updatedAt_DESC) {
          id name country region hubID serviceRange phone email
          location { latitude longitude }
          updatedAt
          image { url }
        }
      }`;




    // ===== MAP INIT =====
    mapboxgl.accessToken = MAPBOX_TOKEN;
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [25.0, 15.0],
      zoom: 2.5
    });

// === ‚¨áÔ∏è ADD THIS CODE ‚¨áÔ∏è ===

    // 1. Add Zoom (Navigation) control
    // This adds zoom in, zoom out, and a compass
    const navControl = new mapboxgl.NavigationControl();
    map.addControl(navControl, 'bottom-right');
    
    // 2. Add "Locate Me" (Geolocate) control
    const geolocateControl = new mapboxgl.GeolocateControl({
      positionOptions: {
        enableHighAccuracy: true
      },
      trackUserLocation: true, // Continuously update location
      showUserHeading: true    // Show direction user is facing
    });
    map.addControl(geolocateControl, 'bottom-right');
    
    // === ‚¨ÜÔ∏è END OF NEW CODE ‚¨ÜÔ∏è ===



    
    const INITIAL_MAP_CENTER = map.getCenter();
    const INITIAL_MAP_ZOOM = map.getZoom();

    // Simple symbol icons (base64) ‚Äî no external files required
    const ICON_MAP = {
      fullCapabilityHub: 'manufacturing-icon',
      supportCenter: 'support-icon'
    };
    const MANUFACTURING_BASE64 = 'data:image/png;base64,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';
    const SUPPORT_BASE64 = 'data:image/png;base64,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';

    function loadMapIcons(){
      return new Promise((resolve) => {
        const icons = [
          { id: ICON_MAP.fullCapabilityHub, path: MANUFACTURING_BASE64 },
          { id: ICON_MAP.supportCenter, path: SUPPORT_BASE64 }
        ];
        let loaded = 0;
        icons.forEach(({id, path}) => {
          map.loadImage(path, (err, img) => {
            if (!err && img && !map.hasImage(id)) map.addImage(id, img);
            loaded++; if (loaded === icons.length) resolve();
          });
        });
      });
    }

    // ===== DATA =====
    async function fetchCenters(){
      const res = await fetch(HYGRAPH_ENDPOINT, {
        method:'POST', headers:{ 'Content-Type':'application/json' }, cache:'no-store',
        body: JSON.stringify({ query: QUERY })
      });
      const json = await res.json();
      if (!json.data) { console.error('Hygraph error:', json.errors || json); return []; }
      const list = (json.data.serviceNetworks || []).filter(c => c.location);
      return list.map(c => ({
        id: c.id,
        name: c.name,
        country: c.country || '',
        region: c.region || '',
        hubID: c.hubID || '',
        phone: c.phone || '',
        email: c.email || '',
        services: c.serviceRange,
        logo: (c.image && c.image.url) || '',
        location: { lat: c.location.latitude, lng: c.location.longitude }
      }));
    }

    const SERVICE_ICON_MAP = {
      'AV Manufacturing': 'üè≠',
      'AV After Sales': '‚öôÔ∏è',
      'AV Spares Support': 'üß∞',
      'AV Disposals': '‚ôªÔ∏è',
      'AV Service Support': 'üõ†Ô∏è'
    };

    const normalizePhone = s => (s||'').replace(/[^\d]/g,'');

    function getServiceIconsHTML(p){
      const data = SERVICE_LABEL[p.serviceKey];
      const items = Array.isArray(data) ? data : (data ? [data] : []);
      return items.map(label => SERVICE_ICON_MAP[label] || '').filter(Boolean)
        .map(sym => `<span title="${sym}" aria-hidden="true">${sym}</span>`).join('');
    }

    function hoverHTML(p){
      const isFC = p.serviceKey === 'fullCapabilityHub';
      const sub = isFC ? 'Full Capability Hub' : 'Regional Service Hub';
      const CENTRAL_WA = '971527118654';
      const waNumber = normalizePhone(p.phone) || CENTRAL_WA;
      const whatsappMsg = encodeURIComponent(`Hub ID: ${p.hubID || 'N/A'} | Support Request`);
      const waHref = `https://wa.me/${waNumber}?text=${whatsappMsg}`;
      const mailHref = `mailto:${p.email || 'support@mahindraarmored.com'}`;
      return `
        <div class="hover-card" style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:start;">
          <div class="info">
            <div class="title" style="font-weight:700;">${p.country || ''}</div>
            <div class="subtitle" style="font-size:13px;color:#555;">${sub}</div>
            <div class="svc-icons" style="display:flex;gap:8px;margin-top:4px;">${getServiceIconsHTML(p)}</div>
          </div>
          <div class="actions" style="display:grid;gap:6px;justify-items:end;">
            <a class="badge" href="${waHref}" target="_blank" rel="noopener" title="WhatsApp" style="display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid rgba(0,0,0,.12);border-radius:6px;">üí¨</a>
            <a class="badge" href="${mailHref}" title="Email" style="display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid rgba(0,0,0,.12);border-radius:6px;">‚úâÔ∏è</a>
          </div>
        </div>`;
    }

    function popupHTML(p){
      const isFC = p.serviceKey === 'fullCapabilityHub';
      const CENTRAL_WA = '971527118654';
      const waNumber = normalizePhone(p.phone) || CENTRAL_WA;
      const waHref = `https://wa.me/${waNumber}?text=${encodeURIComponent('Hub ID: ' + (p.hubID||'N/A'))}`;
      const mailHref = `mailto:${p.email || 'support@mahindraarmored.com'}`;

      const serviceData = SERVICE_LABEL[p.serviceKey] || p.serviceKey || '';
      const serviceHTML = Array.isArray(serviceData)
        ? `<ul style="padding-left:20px;margin-top:6px;list-style:disc;color:#4b5563;">${serviceData.map(i=>`<li>${i}</li>`).join('')}</ul>`
        : `<p style="margin-top:6px;">${String(serviceData || '‚Äî')}</p>`;

      const title = isFC
        ? '<strong><span style="color:#E41837;">End‚Äëto‚ÄëEnd</span> Armoured Vehicle Services</strong>'
        : `<strong>Regional Support Hub ‚Äî <span style="color:#E41837;">${p.country || '‚Äî'}</span></strong>`;

      // üîÑ RE-INTEGRATED LOGO LOGIC
      const logoHTML = p.logo
        ? `<div style="text-align: center; padding-top: 10px; margin-bottom: 10px;">
              <div style="
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background-color: #E6E6E6;
                overflow: hidden;
                margin: 0 auto 5px auto;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
              ">
                <img src="${p.logo}" alt="${p.name} logo" style="
                  width: 100%;
                  height: 100%;
                  object-fit: contain;
                  object-position: center;
                  display: block;
                ">
              </div>
            </div>`
        : '';

      return `
        <div class="popup full-capability">
          ${logoHTML}
          <p>${title}</p>
          ${serviceHTML}
          <div class="contact-buttons">
            <a href="${waHref}" target="_blank" rel="noopener">WhatsApp</a>
            <a href="${mailHref}">Email</a>
          </div>
          ${!isFC ? `<div style="background:#f3f4f6;padding:8px;border-radius:6px;text-align:center;margin-top:6px;">HUB ID: <strong>${p.hubID || ''}</strong></div>` : ''}
        </div>`;
    }

    // ===== STATE =====
    let allCenters = [];
    let currentRegionFilter = '';
    let hoverPopup = null, hoverCloseTimer = null, detailOpen = false, lastHoverId = null;

    function cleanupHover(){
      if (hoverCloseTimer){ clearTimeout(hoverCloseTimer); hoverCloseTimer = null; }
      if (hoverPopup){ hoverPopup.remove(); hoverPopup = null; }
      lastHoverId = null; map.getCanvas().style.cursor = '';
    }

    ['dragstart','zoomstart','movestart','styledata'].forEach(ev => map.on(ev, cleanupHover));

    function toGeoJSON(list){
      return {
        type: 'FeatureCollection',
        features: list.map(c => ({
          type: 'Feature',
          properties: {
            id: c.id, name: c.name, country: c.country, region: c.region,
            hubID: c.hubID, phone: c.phone, email: c.email, serviceKey: c.services, logo: c.logo
          },
          geometry: { type: 'Point', coordinates: [c.location.lng, c.location.lat] }
        }))
      };
    }

    function buildRegionChips(list){
      const container = document.getElementById('regionChips');
      const order = ['AMER','EMEA','APAC'];
      const regions = [...new Set(list.map(c=>c.region).filter(Boolean))].sort((a,b)=>order.indexOf(a)-order.indexOf(b));
      
      // *** MODIFIED LINE HERE ***
      // We are directly building the chips array from 'regions', skipping the hardcoded 'Global' chip.
      const chips = regions.map(code => ({ 
        code, 
        label:(REGION_LABEL[code]||code).split(':')[0].trim(), 
        title: REGION_LABEL[code]||code 
      }));
      // *** END MODIFICATION ***
      
      container.innerHTML = chips.map(({code,label,title}) => `
        <button class="region-chip${code===currentRegionFilter?' active':''}" data-region="${code}" title="${title}">${label}</button>
      `).join('');
      container.onclick = e => {
        const btn = e.target.closest('.region-chip'); if (!btn) return;
        const code = btn.getAttribute('data-region')||''; 
        // NOTE: The 'code' will never be '' now, so the next line is safe.
        if (currentRegionFilter===code) return;
        currentRegionFilter = code; container.querySelectorAll('.region-chip').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
        applyFiltersAndRender();
      };
    }

    function applyFiltersAndRender(){
      const r = currentRegionFilter;
      const inBounds = allCenters.filter(c => !r || c.region === r);

      const src = map.getSource('svc');
      if (!src){
        map.addSource('svc', { type:'geojson', data: toGeoJSON(allCenters), cluster: false });
        map.addLayer({
          id:'points', type:'symbol', source:'svc',
          layout:{
            'icon-image': [ 'case', ['==',['get','serviceKey'],'fullCapabilityHub'], ICON_MAP.fullCapabilityHub, ICON_MAP.supportCenter ],
            'icon-allow-overlap': true,
            'icon-ignore-placement': true,
            'icon-size': ['interpolate', ['linear'], ['zoom'], 3, 0.4, 9, 1.0, 12, 2.0]
          }
        });

        // Click popup (detail)
        map.on('click','points',(e)=>{
          cleanupHover(); detailOpen = true;
          const f = e.features[0];
          new mapboxgl.Popup({ closeOnMove: true })
            .setLngLat(f.geometry.coordinates)
            .setHTML(popupHTML(f.properties))
            .addTo(map)
            .on('close', ()=>{ detailOpen = false; });
        });

        // Always enable hover handlers (no touch guard)
        map.on('mouseenter','points',(e)=>{
          if (detailOpen) return;
          map.getCanvas().style.cursor = 'pointer';
          const f = e.features[0]; const p = f.properties; const id = f.id || p.id || JSON.stringify(p);
          if (!hoverPopup){
            hoverPopup = new mapboxgl.Popup({ closeButton:false, closeOnClick:false, offset:14, className:'hover-popup' })
              .setLngLat(f.geometry.coordinates)
              .setHTML(hoverHTML(p))
              .addTo(map);
            lastHoverId = id;
            const el = hoverPopup.getElement();
            el.addEventListener('mouseenter', ()=>{ if (hoverCloseTimer){ clearTimeout(hoverCloseTimer); hoverCloseTimer=null; } });
            el.addEventListener('mouseleave', ()=>{ hoverCloseTimer = setTimeout(()=>cleanupHover(), 150); });
          }
        });
        map.on('mousemove','points',(e)=>{
          if (!hoverPopup) return;
          const f = e.features && e.features[0]; if (!f) return;
          const p = f.properties; const id = f.id || p.id || JSON.stringify(p);
          if (id !== lastHoverId){ hoverPopup.setHTML(hoverHTML(p)); lastHoverId = id; }
          hoverPopup.setLngLat(f.geometry.coordinates);
        });
        map.on('mouseleave','points',()=>{ hoverCloseTimer = setTimeout(()=>cleanupHover(), 120); });
      }

      // Fly to bounds of filtered set
      if (inBounds.length){
        const b = new mapboxgl.LngLatBounds();
        inBounds.forEach(c=>b.extend([c.location.lng, c.location.lat]));
        try{ map.fitBounds(b, { padding:50, maxZoom:6 }); }catch{}
      } else {
        map.flyTo({ center:[20,10], zoom:2 });
      }
    }

    // Geocoder (countries only)
    const geocoder = new MapboxGeocoder({ accessToken: MAPBOX_TOKEN, mapboxgl, marker:false, placeholder:'Search MEVA Hubs', proximity:{ longitude:25, latitude:15 } });
    geocoder.on('results', (res) => {
      if (res && Array.isArray(res.features)) {
        res.features = res.features.filter(f => Array.isArray(f.place_type) && f.place_type.includes('country'));
      }
    });
    document.getElementById('geocoder-container').appendChild(geocoder.onAdd(map));

    // Reset
    document.getElementById('resetMapBtn').onclick = ()=>{
      currentRegionFilter = '';
      document.querySelectorAll('#regionChips .region-chip').forEach(b=>b.classList.remove('active'));
      const globalBtn = document.querySelector('#regionChips .region-chip[data-region=""]'); if (globalBtn) globalBtn.classList.add('active');
      applyFiltersAndRender();
      map.flyTo({ center: INITIAL_MAP_CENTER, zoom: INITIAL_MAP_ZOOM, bearing:0, pitch:0, essential:true });
    };

    (async ()=>{
      await new Promise(res => map.on('load', res));
      await loadMapIcons();
      allCenters = await fetchCenters();
      buildRegionChips(allCenters);
      applyFiltersAndRender();

      // Debug helpers (optional):
      console.log('centers:', allCenters.length);
      console.log('touch-detected:', ('ontouchstart' in window) || navigator.maxTouchPoints > 0);
    })();
  </script>
  <script src="sidebar.js"></script>
</body>
</html>









