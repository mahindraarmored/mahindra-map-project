<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mahindra Emirates Vehicle Armouring - Global Support Network</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Mapbox CSS/JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

  <!-- Geocoder CSS/JS -->
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Georama:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
/* üîë KEY CHANGE: General Map/Body setup */
html, body, #map { height: 100%; margin: 0; }
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; overflow-x: hidden; }

/* üîë KEY CHANGE: Panel Positioning (Centered, Wide, White Background) */
.panel{
    position:absolute; top:10px; z-index:2; 
    left: 14px; /* Anchor to the left side */
    transform: none; /* No horizontal centering transform */
    width: min(400px, 90vw); /* Adjust desktop width for a typical sidebar size */
    /* Set padding for the top section (search bar) */
    padding: 10px 14px 0 14px; 
    /* Give it a solid background and rounded corners like Google Maps */
    /* background: #fff; */
    border-radius: 12px;
    /* box-shadow: 0 4px 12px rgba(0,0,0,0.15); */
    display:flex; flex-direction:column; gap:0; /* Ensure internal elements stack */
    font-family:"Georama", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
}

:root{
    /* Geocoder/Primary Control Height: clamp(38px, 4.2vw, 46px) */
    --ctrl-h: clamp(38px, 4.2vw, 46px);
    --ctrl-pad-x: clamp(10px, 1.2vw, 16px);
    --ctrl-radius: 9999px;
    --ctrl-fs: clamp(12px, 1.1vw, 15px);
    --input-fs: clamp(14px, 1.2vw, 16px);
    --icon-left: 14px;

    /* Chip Height (2/3 of search bar) */
    --chip-h: calc(var(--ctrl-h) * 0.75); /* Slight bump for touch targets */
    --chip-fs: clamp(12px, 1.1vw, 14px);
    --chip-pad-y: 0; /* No vertical padding, let height define size */
}

/* üîë KEY CHANGE: Search and Reset Button Row (Flex) */
#search-and-controls-group{
    display:flex;
    align-items:center;
    gap:10px;
    width: 100%;
    padding-bottom: 10px; /* Space between search and chips */
}

/* MODIFIED: Ensure geocoder container takes available space */
#geocoder-container{
    flex: 1 1 auto; /* Takes remaining space */
    min-width:0;
}
#geocoder-container .mapboxgl-ctrl-geocoder{
    width:100% !important;
    height:var(--ctrl-h); min-height:var(--ctrl-h);
    border-radius:var(--ctrl-radius); border:1px solid #d0d0d0; background:#fff;
    box-shadow:none; /* Remove shadow here, the panel has one */
}
#geocoder-container .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--input{
    height:calc(var(--ctrl-h) - 2px);
    line-height:calc(var(--ctrl-h) - 2px);
    font-size:var(--input-fs);
    padding:0 var(--ctrl-pad-x) 0 calc(var(--icon-left) + 24px);
    box-sizing:border-box;
}
#geocoder-container .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--icon{
    left:var(--icon-left); top:50%; transform:translateY(-50%);
}

/* üîë KEY CHANGE: Reset button as a small, secondary action (like the transit button in the image) */
#resetMapBtn{
    flex-shrink: 0;
    width: var(--ctrl-h); /* Make it a square for a clean icon-only look */
    height:var(--ctrl-h); 
    border-radius:var(--ctrl-radius); 
    border:1px solid #d0d0d0; background:#fff;
    box-shadow:none;
    display:inline-flex; align-items:center; justify-content:center;
    font-weight:600; font-size:var(--ctrl-fs); line-height:1;
    cursor:pointer; user-select:none;
    transition:background-color .15s ease, color .15s ease, border-color .15s ease;
    padding: 0; /* Remove padding since it's a square button */
}
@media (min-width: 720px){
    #resetMapBtn:hover{ background:#f0f0f0; }
}

/* üîë KEY CHANGE: Chip Scroll Row (The core change for the Google Maps pattern) */
#chip-scroll-row {
    display: flex;
    overflow-x: auto; /* Allow horizontal scrolling */
    -webkit-overflow-scrolling: touch; /* Improved scrolling on iOS */
    white-space: nowrap; /* Prevent chips from wrapping */
    
    /* Negative margin to ensure the scrolling area spans the full panel width */
    margin: 0 -14px; 
    padding: 0 14px 14px 14px; /* Internal padding matches panel edge, plus bottom space */
    
    /* Hide the scrollbar but keep the function */
    scrollbar-width: none; /* Firefox */
}
#chip-scroll-row::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
}


/* MODIFIED: Chips inside the scroll row */
#regionChips{
    display:flex; gap:8px;
    flex: none; /* Do not allow flex properties to resize the chip container */
    flex-wrap: nowrap; /* Essential: Prevents chips from wrapping */
    justify-content: flex-start;
    align-items: flex-start;
}
.region-chip{
    flex-shrink: 0; /* Essential: Prevents chips from shrinking */
    
    /* Use the smaller chip height and font size */
    height:var(--chip-h);
    padding:0 var(--ctrl-pad-x);
    font-size:var(--chip-fs); 
    
    border-radius:var(--ctrl-radius); 
    border:1px solid #d0d0d0; background:#fff;
    box-shadow:0 1px 2px rgba(0,0,0,.06);
    display:inline-flex; align-items:center; justify-content:center;
    line-height:1; cursor:pointer; user-select:none;
    transition:background-color .15s ease, color .15s ease, border-color .15s ease, box-shadow .15s ease;
}
.region-chip:hover{ background:#f0f0f0;; border-color:#f0f0f0; }
.region-chip.active{ background:#e41837; color:#fff; border-color:#e41837; }


/* --- Mapbox Controls and Popups (No major changes needed here) --- */

/* Popup styles */
.mapboxgl-popup-content{ padding:10px; max-width:min(90vw, 420px); padding-bottom:12px; }
.popup h3{ margin:0 0 4px; font-size:clamp(14px,1.5vw,18px); }
.popup p{ margin:0; font-size:clamp(12px,1.3vw,14px); line-height:1.35; overflow-wrap:anywhere; }
.contact-buttons{ display:flex; gap:10px; margin-top:12px; margin-bottom:10px; justify-content:center; padding-bottom:10px; }
.contact-buttons a{
    display:inline-block; padding:6px 10px; border-radius:9999px; text-decoration:none;
    font-weight:700; background:#fff; color:#E41837; border:1px solid #E41837;
    transition:background-color .2s, color .2s, border-color .2s;
}
.contact-buttons a:hover{ background:#E41837; color:#fff; }

/* Mapbox controls: put attribution bottom-left */
.mapboxgl-ctrl-bottom-left{
    position:absolute; left:14px; bottom:14px; display:flex !important; flex-direction:column-reverse !important; gap:6px;
}
.mapboxgl-ctrl-bottom-left .mapboxgl-ctrl-attrib{ order:2; margin:0 !important; background:none; padding:2px 6px; font-size:11px; }
.mapboxgl-ctrl-bottom-left .mapboxgl-ctrl-scale{ display:none !important; }

.mapboxgl-ctrl-bottom-right .mapboxgl-ctrl-group {
    margin-bottom: 10px;
    box-shadow: 0 1px 2px rgba(0,0,0,.06);
}

/* üîë KEY CHANGE: Mobile (<= 420px) is CENTERED */
@media (max-width: 420px) {
    .panel {
        /* Override the desktop 'left' position */
        left: 50% !important;
        /* Center the panel by shifting it back by half its own width */
        transform: translateX(-50%) !important;
        /* Ensure it takes up most of the screen width on mobile */
        width: 96vw;
    }
    
    /* Optional: Hide the scrollbar in the chip row for a cleaner mobile look */
    #chip-scroll-row {
        scrollbar-width: none; /* Firefox */
    }
    #chip-scroll-row::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
    }
}
</style>
</head>
<body>

  <div class="panel" aria-label="Search and Filters">
  <div id="search-and-controls-group"> 
    <div id="geocoder-container"></div>
    <button id="resetMapBtn" title="Reset map">‚ü≤</button> 
  </div>
  <div id="chip-scroll-row"> 
    <div id="regionChips" aria-label="Regions"></div>
  </div>
</div>
<div id="map" role="region" aria-label="Global Service Network"></div>

  <script>
    // ===== CONFIG =====
    const MAPBOX_TOKEN = 'pk.eyJ1IjoibnJhanBrIiwiYSI6ImNtZnFoejJhaDBua2cybHM4dHRtZ2xycW4ifQ.wAJkzxTCQiRmIZuSyW59Uw';
    const HYGRAPH_ENDPOINT = 'https://ap-south-1.cdn.hygraph.com/content/cmfpk332g005s08uylh0ezd8a/master';

    const REGION_LABEL = {
      AMER: 'üåé AMER: North & Latin America',
      EMEA: 'üåç EMEA: Europe, Middle East, Africa',
      APAC: 'üåè APAC: Asia Pacific (Asia + Oceania)'
    };
    const GLOBAL_TITLE = 'View All Regions Worldwide';

    const SERVICE_LABEL = {
      fullCapabilityHub: [ 'AV Manufacturing', 'AV After Sales', 'AV Spares Support', 'AV Disposals' ],
      otherServiceLocations: 'Other Service Locations',
      supportCenter: [ 'AV Service Support', 'AV Spares Support', 'AV Disposals' ]
    };

    // GraphQL query
    const QUERY = `
      query {
        serviceNetworks(stage: PUBLISHED, first: 1000, orderBy: updatedAt_DESC) {
          id name country region hubID serviceRange phone email
          location { latitude longitude }
          updatedAt
          image { url }
        }
      }`;




    // ===== MAP INIT =====
    mapboxgl.accessToken = MAPBOX_TOKEN;
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [25.0, 15.0],
      zoom: 2.5
    });

// === ‚¨áÔ∏è ADD THIS CODE ‚¨áÔ∏è ===

    // 1. Add Zoom (Navigation) control
    // This adds zoom in, zoom out, and a compass
    const navControl = new mapboxgl.NavigationControl();
    map.addControl(navControl, 'bottom-right');
    
    // 2. Add "Locate Me" (Geolocate) control
    const geolocateControl = new mapboxgl.GeolocateControl({
      positionOptions: {
        enableHighAccuracy: true
      },
      trackUserLocation: true, // Continuously update location
      showUserHeading: true    // Show direction user is facing
    });
    map.addControl(geolocateControl, 'bottom-right');
    
    // === ‚¨ÜÔ∏è END OF NEW CODE ‚¨ÜÔ∏è ===



    
    const INITIAL_MAP_CENTER = map.getCenter();
    const INITIAL_MAP_ZOOM = map.getZoom();

    // Simple symbol icons (base64) ‚Äî no external files required
    const ICON_MAP = {
      fullCapabilityHub: 'manufacturing-icon',
      supportCenter: 'support-icon'
    };





// New constant for the Email SVG
const EMAIL_SVG = `
  <svg viewBox="0 0 1920 1920" xmlns="http://www.w3.org/2000/svg" style="width:24px; height:24px; display:block;" fill="#3a88fe">
    <path d="M1920 428.266v1189.54l-464.16-580.146-88.203 70.585 468.679 585.904H83.684l468.679-585.904-88.202-70.585L0 1617.805V428.265l959.944 832.441L1920 428.266ZM1919.932 226v52.627l-959.943 832.44L.045 278.628V226h1919.887Z" fill-rule="evenodd"></path>
  </svg>
`;

// Existing constant for the WhatsApp SVG (for completeness)
const WHATSAPP_SVG = `
  <svg viewBox="0 0 48 48" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="width:24px; height:24px; display:block;" fill="currentColor">
    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
      <g transform="translate(-700.000000, -360.000000)" fill="#25D366">
        <path d="M723.993033,360 C710.762252,360 700,370.765287 700,383.999801 C700,389.248451 701.692661,394.116025 704.570026,398.066947 L701.579605,406.983798 L710.804449,404.035539 C714.598605,406.546975 719.126434,408 724.006967,408 C737.237748,408 748,397.234315 748,384.000199 C748,370.765685 737.237748,360.000398 724.006967,360.000398 L723.993033,360.000398 L723.993033,360 Z M717.29285,372.190836 C716.827488,371.07628 716.474784,371.034071 715.769774,371.005401 C715.529728,370.991464 715.262214,370.977527 714.96564,370.977527 C714.04845,370.977527 713.089462,371.245514 712.511043,371.838033 C711.806033,372.557577 710.056843,374.23638 710.056843,377.679202 C710.056843,381.122023 712.567571,384.451756 712.905944,384.917648 C713.258648,385.382743 717.800808,392.55031 724.853297,395.471492 C730.368379,397.757149 732.00491,397.545307 733.260074,397.27732 C735.093658,396.882308 737.393002,395.527239 737.971421,393.891043 C738.54984,392.25405 738.54984,390.857171 738.380255,390.560912 C738.211068,390.264652 737.745308,390.095816 737.040298,389.742615 C736.335288,389.389811 732.90737,387.696673 732.25849,387.470894 C731.623543,387.231179 731.017259,387.315995 730.537963,387.99333 C729.860819,388.938653 729.198006,389.89831 728.661785,390.476494 C728.238619,390.928051 727.547144,390.984595 726.969123,390.744481 C726.193254,390.420348 724.021298,389.657798 721.340985,387.273388 C719.267356,385.42535 717.856938,383.125756 717.448104,382.434484 C717.038871,381.729275 717.405907,381.319529 717.729948,380.938852 C718.082653,380.501232 718.421026,380.191036 718.77373,379.781688 C719.126434,379.372738 719.323884,379.160897 719.549599,378.681068 C719.789645,378.215575 719.62006,377.735746 719.450874,377.382942 C719.281687,377.030139 717.871269,373.587317 717.29285,372.190836 Z" id="Whatsapp"> </path>
      </g>
    </g>
  </svg>
`;



    const MANUFACTURING_BASE64 = 'data:image/png;base64,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';
    const SUPPORT_BASE64 = 'data:image/png;base64,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';

    function loadMapIcons(){
      return new Promise((resolve) => {
        const icons = [
          { id: ICON_MAP.fullCapabilityHub, path: MANUFACTURING_BASE64 },
          { id: ICON_MAP.supportCenter, path: SUPPORT_BASE64 }
        ];
        let loaded = 0;
        icons.forEach(({id, path}) => {
          map.loadImage(path, (err, img) => {
            if (!err && img && !map.hasImage(id)) map.addImage(id, img);
            loaded++; if (loaded === icons.length) resolve();
          });
        });
      });
    }

    // ===== DATA =====
    async function fetchCenters(){
      const res = await fetch(HYGRAPH_ENDPOINT, {
        method:'POST', headers:{ 'Content-Type':'application/json' }, cache:'no-store',
        body: JSON.stringify({ query: QUERY })
      });
      const json = await res.json();
      if (!json.data) { console.error('Hygraph error:', json.errors || json); return []; }
      const list = (json.data.serviceNetworks || []).filter(c => c.location);
      return list.map(c => ({
        id: c.id,
        name: c.name,
        country: c.country || '',
        region: c.region || '',
        hubID: c.hubID || '',
        phone: c.phone || '',
        email: c.email || '',
        services: c.serviceRange,
        logo: (c.image && c.image.url) || '',
        location: { lat: c.location.latitude, lng: c.location.longitude }
      }));
    }

    const SERVICE_ICON_MAP = {
      'AV Manufacturing': 'üè≠',
      'AV After Sales': '‚öôÔ∏è',
      'AV Spares Support': 'üß∞',
      'AV Disposals': '‚ôªÔ∏è',
      'AV Service Support': 'üõ†Ô∏è'
    };

    const normalizePhone = s => (s||'').replace(/[^\d]/g,'');

    function getServiceIconsHTML(p){
      const data = SERVICE_LABEL[p.serviceKey];
      const items = Array.isArray(data) ? data : (data ? [data] : []);
      return items.map(label => SERVICE_ICON_MAP[label] || '').filter(Boolean)
        .map(sym => `<span title="${sym}" aria-hidden="true">${sym}</span>`).join('');
    }



function hoverHTML(p){
  const isFC = p.serviceKey === 'fullCapabilityHub';
  const sub = isFC ? 'Full Capability Hub' : 'Regional Service Hub';
  const CENTRAL_WA = '971527118654';
  const waNumber = normalizePhone(p.phone) || CENTRAL_WA;
  const whatsappMsg = encodeURIComponent(`Hub ID: ${p.hubID || 'N/A'} | Support Request`);
  const waHref = `https://wa.me/${waNumber}?text=${whatsappMsg}`;
  const mailHref = `mailto:${p.email || 'support@mahindraarmored.com'}`;
  
  // NOTE: For better visual spacing, I've increased the badge size to 40px
  // and ensured the icons inside are 20px.
  const BADGE_SIZE = '40px'; 
  const ICON_SIZE = '20px';

  // We modify the SVG constants to include the new size for consistency:
  const WHATSAPP_SVG_20PX = WHATSAPP_SVG.replace('width:24px; height:24px;', `width:${ICON_SIZE}; height:${ICON_SIZE};`);
  const EMAIL_SVG_20PX = EMAIL_SVG.replace('width:24px; height:24px;', `width:${ICON_SIZE}; height:${ICON_SIZE};`);
  
  return `
    <div class="hover-card" style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:start;">
      <div class="info">
        <div class="title" style="font-weight:700;">${p.country || ''}</div>
        <div class="subtitle" style="font-size:13px;color:#555;">${sub}</div>
        <div class="svc-icons" style="display:flex;gap:8px;margin-top:4px;">${getServiceIconsHTML(p)}</div>
      </div>
      <div class="actions" style="display:grid;gap:6px;justify-items:end;">
        <a class="badge" href="${waHref}" target="_blank" rel="noopener" title="WhatsApp" 
           style="display:inline-flex;align-items:center;justify-content:center;width:${BADGE_SIZE};height:${BADGE_SIZE};border:1px solid rgba(0,0,0,.12);border-radius:6px;">
          ${WHATSAPP_SVG_20PX}
        </a>
        <a class="badge" href="${mailHref}" title="Email" 
           style="display:inline-flex;align-items:center;justify-content:center;width:${BADGE_SIZE};height:${BADGE_SIZE};border:1px solid rgba(0,0,0,.12);border-radius:6px;">
          ${EMAIL_SVG_20PX}
        </a>
      </div>
    </div>`;
}
    function popupHTML(p){
      const isFC = p.serviceKey === 'fullCapabilityHub';
      const CENTRAL_WA = '971527118654';
      const waNumber = normalizePhone(p.phone) || CENTRAL_WA;
      const waHref = `https://wa.me/${waNumber}?text=${encodeURIComponent('Hub ID: ' + (p.hubID||'N/A'))}`;
      const mailHref = `mailto:${p.email || 'support@mahindraarmored.com'}`;

      const serviceData = SERVICE_LABEL[p.serviceKey] || p.serviceKey || '';
      const serviceHTML = Array.isArray(serviceData)
        ? `<ul style="padding-left:20px;margin-top:6px;list-style:disc;color:#4b5563;">${serviceData.map(i=>`<li>${i}</li>`).join('')}</ul>`
        : `<p style="margin-top:6px;">${String(serviceData || '‚Äî')}</p>`;

      const title = isFC
        ? '<strong><span style="color:#E41837;">End‚Äëto‚ÄëEnd</span> Armoured Vehicle Services</strong>'
        : `<strong>Regional Support Hub ‚Äî <span style="color:#E41837;">${p.country || '‚Äî'}</span></strong>`;

      // üîÑ RE-INTEGRATED LOGO LOGIC
      const logoHTML = p.logo
        ? `<div style="text-align: center; padding-top: 10px; margin-bottom: 10px;">
              <div style="
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background-color: #E6E6E6;
                overflow: hidden;
                margin: 0 auto 5px auto;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
              ">
                <img src="${p.logo}" alt="${p.name} logo" style="
                  width: 100%;
                  height: 100%;
                  object-fit: contain;
                  object-position: center;
                  display: block;
                ">
              </div>
            </div>`
        : '';

      return `
        <div class="popup full-capability">
          ${logoHTML}
          <p>${title}</p>
          ${serviceHTML}
          <div class="contact-buttons">
            <a href="${waHref}" target="_blank" rel="noopener">WhatsApp</a>
            <a href="${mailHref}">Email</a>
          </div>
          ${!isFC ? `<div style="background:#f3f4f6;padding:8px;border-radius:6px;text-align:center;margin-top:6px;">HUB ID: <strong>${p.hubID || ''}</strong></div>` : ''}
        </div>`;
    }

    // ===== STATE =====
    let allCenters = [];
    let currentRegionFilter = '';
    let hoverPopup = null, hoverCloseTimer = null, detailOpen = false, lastHoverId = null;

    function cleanupHover(){
      if (hoverCloseTimer){ clearTimeout(hoverCloseTimer); hoverCloseTimer = null; }
      if (hoverPopup){ hoverPopup.remove(); hoverPopup = null; }
      lastHoverId = null; map.getCanvas().style.cursor = '';
    }

    ['dragstart','zoomstart','movestart','styledata'].forEach(ev => map.on(ev, cleanupHover));

    function toGeoJSON(list){
      return {
        type: 'FeatureCollection',
        features: list.map(c => ({
          type: 'Feature',
          properties: {
            id: c.id, name: c.name, country: c.country, region: c.region,
            hubID: c.hubID, phone: c.phone, email: c.email, serviceKey: c.services, logo: c.logo
          },
          geometry: { type: 'Point', coordinates: [c.location.lng, c.location.lat] }
        }))
      };
    }

    function buildRegionChips(list){
      const container = document.getElementById('regionChips');
      const order = ['AMER','EMEA','APAC'];
      const regions = [...new Set(list.map(c=>c.region).filter(Boolean))].sort((a,b)=>order.indexOf(a)-order.indexOf(b));
      
      // *** MODIFIED LINE HERE ***
      // We are directly building the chips array from 'regions', skipping the hardcoded 'Global' chip.
      const chips = regions.map(code => ({ 
        code, 
        label:(REGION_LABEL[code]||code).split(':')[0].trim(), 
        title: REGION_LABEL[code]||code 
      }));
      // *** END MODIFICATION ***
      
      container.innerHTML = chips.map(({code,label,title}) => `
        <button class="region-chip${code===currentRegionFilter?' active':''}" data-region="${code}" title="${title}">${label}</button>
      `).join('');
      container.onclick = e => {
        const btn = e.target.closest('.region-chip'); if (!btn) return;
        const code = btn.getAttribute('data-region')||''; 
        // NOTE: The 'code' will never be '' now, so the next line is safe.
        if (currentRegionFilter===code) return;
        currentRegionFilter = code; container.querySelectorAll('.region-chip').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
        applyFiltersAndRender();
      };
    }

    function applyFiltersAndRender(){
      const r = currentRegionFilter;
      const inBounds = allCenters.filter(c => !r || c.region === r);

      const src = map.getSource('svc');
      if (!src){
        map.addSource('svc', { type:'geojson', data: toGeoJSON(allCenters), cluster: false });
        map.addLayer({
          id:'points', type:'symbol', source:'svc',
          layout:{
            'icon-image': [ 'case', ['==',['get','serviceKey'],'fullCapabilityHub'], ICON_MAP.fullCapabilityHub, ICON_MAP.supportCenter ],
            'icon-allow-overlap': true,
            'icon-ignore-placement': true,
            'icon-size': ['interpolate', ['linear'], ['zoom'], 3, 0.4, 9, 1.0, 12, 2.0]
          }
        });

        // Click popup (detail)
        map.on('click','points',(e)=>{
          cleanupHover(); detailOpen = true;
          const f = e.features[0];
          new mapboxgl.Popup({ closeOnMove: true })
            .setLngLat(f.geometry.coordinates)
            .setHTML(popupHTML(f.properties))
            .addTo(map)
            .on('close', ()=>{ detailOpen = false; });
        });

        // Always enable hover handlers (no touch guard)
        map.on('mouseenter','points',(e)=>{
          if (detailOpen) return;
          map.getCanvas().style.cursor = 'pointer';
          const f = e.features[0]; const p = f.properties; const id = f.id || p.id || JSON.stringify(p);
          if (!hoverPopup){
            hoverPopup = new mapboxgl.Popup({ closeButton:false, closeOnClick:false, offset:14, className:'hover-popup' })
              .setLngLat(f.geometry.coordinates)
              .setHTML(hoverHTML(p))
              .addTo(map);
            lastHoverId = id;
            const el = hoverPopup.getElement();
            el.addEventListener('mouseenter', ()=>{ if (hoverCloseTimer){ clearTimeout(hoverCloseTimer); hoverCloseTimer=null; } });
            el.addEventListener('mouseleave', ()=>{ hoverCloseTimer = setTimeout(()=>cleanupHover(), 150); });
          }
        });
        map.on('mousemove','points',(e)=>{
          if (!hoverPopup) return;
          const f = e.features && e.features[0]; if (!f) return;
          const p = f.properties; const id = f.id || p.id || JSON.stringify(p);
          if (id !== lastHoverId){ hoverPopup.setHTML(hoverHTML(p)); lastHoverId = id; }
          hoverPopup.setLngLat(f.geometry.coordinates);
        });
        map.on('mouseleave','points',()=>{ hoverCloseTimer = setTimeout(()=>cleanupHover(), 120); });
      }

      // Fly to bounds of filtered set
      if (inBounds.length){
        const b = new mapboxgl.LngLatBounds();
        inBounds.forEach(c=>b.extend([c.location.lng, c.location.lat]));
        try{ map.fitBounds(b, { padding:50, maxZoom:6 }); }catch{}
      } else {
        map.flyTo({ center:[20,10], zoom:2 });
      }
    }

    // Geocoder (countries only)
    const geocoder = new MapboxGeocoder({ accessToken: MAPBOX_TOKEN, mapboxgl, marker:false, placeholder:'Search MEVA Hubs', proximity:{ longitude:25, latitude:15 } });
    geocoder.on('results', (res) => {
      if (res && Array.isArray(res.features)) {
        res.features = res.features.filter(f => Array.isArray(f.place_type) && f.place_type.includes('country'));
      }
    });
    document.getElementById('geocoder-container').appendChild(geocoder.onAdd(map));

   // Reset
document.getElementById('resetMapBtn').onclick = ()=>{
    currentRegionFilter = '';
    
    // üîë KEY CHANGE: Add this line to clear the geocoder input field
    geocoder.clear(); 
    
    document.querySelectorAll('#regionChips .region-chip').forEach(b=>b.classList.remove('active'));
    const globalBtn = document.querySelector('#regionChips .region-chip[data-region=""]'); if (globalBtn) globalBtn.classList.add('active');
    applyFiltersAndRender();
    map.flyTo({ center: INITIAL_MAP_CENTER, zoom: INITIAL_MAP_ZOOM, bearing:0, pitch:0, essential:true });
};

    (async ()=>{
      await new Promise(res => map.on('load', res));
      await loadMapIcons();
      allCenters = await fetchCenters();
      buildRegionChips(allCenters);
      applyFiltersAndRender();

      // Debug helpers (optional):
      console.log('centers:', allCenters.length);
      console.log('touch-detected:', ('ontouchstart' in window) || navigator.maxTouchPoints > 0);
    })();
  </script>
  <script src="sidebar.js"></script>
</body>
</html>
