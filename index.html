<!doctype html>

<html>

<head>

Â  <meta charset="utf-8" />

Â  <title>Commitment beyond Delivery</title>

Â  <meta name="viewport" content="width=device-width,initial-scale=1" />

Â  Â  <meta property="og:title" content="Global Support Hubs - Mahindra Emirates Vehicle Armouring" />

Â  <meta property="og:description" content="Global network of service hubs and support locations dedicated to Armoured Vehicle Spares & Maintenance." />

Â  <meta property="og:image" content="https://support.mahindraarmored.com/MEVA LOGO.png" />

Â  <meta property="og:url" content="https://support.mahindraarmored.com/" />

Â  <meta name="twitter:card" content="summary_large_image" />

Â  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />

Â  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

Â  <style>

Â  html,body,#map{height:100%;margin:0}

Â  .panel{

Â  Â  position:absolute;top:10px;left:10px;z-index:2;background:#fff;

Â  Â  padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.12);

Â  Â  /* MODIFIED: Using clamp for a responsive font size */

Â  Â  font: clamp(12px, 1.4vw, 16px)/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;

Â  Â  display:flex;gap:10px;flex-wrap:wrap;align-items:center;

Â  Â  max-width: 450px;

Â  }

Â  .panel label{display:flex;gap:6px;align-items:center}

Â  .panel select,.panel button{padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px;background:#fff}

Â  .panel button{cursor:pointer}

Â  .legend{

Â  Â  position:absolute;bottom:10px;left:10px;z-index:2;background:#fff;padding:8px 10px;border-radius:8px;

Â  Â  box-shadow:0 6px 18px rgba(0,0,0,.12);Â 

Â  Â  /* MODIFIED: Using clamp for a responsive font size */

Â  Â  font: clamp(11px, 1.3vw, 15px)/1.3 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;

Â  }

Â  .k{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:6px;vertical-align:middle}

Â  .popup h3 {

Â  Â  margin: 0 0 4px;

Â  Â  /* MODIFIED: Using clamp for a responsive font size */

Â  Â  font-size: clamp(14px, 1.5vw, 18px);

Â  }

Â  .popup p {

Â  Â  margin: 0;

Â  Â  /* MODIFIED: Using clamp for a responsive font size */

Â  Â  font-size: clamp(12px, 1.3vw, 14px);

Â  Â  line-height: 1.35;

Â  Â  word-break: break-all;

Â  }

Â  .mapboxgl-popup-content {

Â  Â  padding: 10px;

Â  Â  /* NEW: Constrains the popup width to prevent it from being too wide */

Â  Â  max-width: 250px;

Â  }

</style>

Â Â 

</head>

<body>

Â  <div class="panel">

Â  Â  <label>Region:

Â  Â  Â  <select id="regionFilter">

Â  Â  Â  Â  <option value="">All</option>

Â  Â  Â  </select>

Â  Â  </label>

Â  Â  <button id="locateMe">ğŸ“ Use My Location</button>

Â  Â  <button id="refreshBtn">â†» Refresh</button>

Â  Â  <div style="display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; width: 100%;">

Â  Â  Â  <div><span class="k" style="background:#e11d48"></span> AV Manufacturing Facility</div>

Â  Â  Â  <div><span class="k" style="background:#000000"></span> Regional Support Hubs</div>

Â  Â  </div>

Â  </div>



Â  <div id="map" role="region" aria-label="Global Service Network"></div>



Â  <script>

Â  // ====== CONFIG ======

Â  const MAPBOX_TOKEN = 'pk.eyJ1IjoibnJhanBrIiwiYSI6ImNtZnFoejJhaDBua2cybHM4dHRtZ2xycW4ifQ.wAJkzxTCQiRmIZuSyW59Uw';

Â  const HYGRAPH_ENDPOINT = 'https://api-ap-south-1.hygraph.com/v2/cmfpk332g005s08uylh0ezd8a/master';



Â  // UPDATED: Label map for regions to match your Hygraph data

Â  const REGION_LABEL = {

Â  Â  AMER: 'AMER â†’ North & Latin America',

Â  Â  EMEA: 'EMEA â†’ Europe, Middle East, Africa',

Â  Â  APAC: 'APAC â†’ Asia Pacific (Asia + Oceania)'

Â  };



Â  // ADDED: Label map for services to fix the popup

Â  const SERVICE_LABEL = {

Â  Â  'fullCapabilityHub': 'Full-Capability Hub',

Â  Â  'otherServiceLocations': 'Other Service Locations',

Â  Â  'certifiedService': 'Certified Service'

Â  };



Â  // ====== GQL QUERY ======

Â  // MODIFIED: Added 'image { url }' to fetch the logo

Â  const QUERY = `

Â  Â  query {

Â  Â  Â  serviceNetworks(stage: PUBLISHED, first: 1000, orderBy: updatedAt_DESC) {

Â  Â  Â  Â  id name country region services: serviceRange phone email

Â  Â  Â  Â  location { latitude longitude }

Â  Â  Â  Â  updatedAt

Â  Â  Â  Â  image { url }

Â  Â  Â  }

Â  Â  }`;



Â  // ====== MAP INIT ======

Â  mapboxgl.accessToken = MAPBOX_TOKEN;

Â  const map = new mapboxgl.Map({

Â  Â  container:'map',

Â  Â  style:'mapbox://styles/mapbox/streets-v12',

Â  Â  // UPDATED: Set the default center and zoom to match the desired view

Â  Â  center:[25.0, 15.0],

Â  Â  zoom:2.5

Â  });

Â  map.addControl(new mapboxgl.NavigationControl());



Â  // ====== DOM ======

Â  const regionSelectÂ  = document.getElementById('regionFilter');

Â  const locateBtnÂ  Â  Â = document.getElementById('locateMe');

Â  const refreshBtnÂ  Â  = document.getElementById('refreshBtn');



Â  // ====== STATE ======

Â  let allCenters = [];

Â  let currentGeo = null;



Â  // ====== FETCH ======

Â  async function fetchCenters(){

Â  Â  const res = await fetch(HYGRAPH_ENDPOINT, {

Â  Â  Â  method:'POST',

Â  Â  Â  headers:{

Â  Â  Â  Â  'Content-Type':'application/json',

Â  Â  Â  Â  'Cache-Control':'no-cache'

Â  Â  Â  },

Â  Â  Â  cache:'no-store',

Â  Â  Â  body: JSON.stringify({ query: QUERY })

Â  Â  });

Â  Â  const json = await res.json();

Â  Â  if (!json.data) {

Â  Â  Â  console.error('Hygraph error:', json.errors || json);

Â  Â  Â  return [];

Â  Â  }

Â  Â  return (json.data.serviceNetworks || []).filter(c => c.location);

Â  }



Â  // ====== FILTER UI BUILD (Regions only) ======

Â  function buildRegionFilter(list){

Â  Â  const regions = [...new Set(list.map(c => c.region).filter(Boolean))].sort();

Â  Â  regionSelect.innerHTML = '<option value="">All</option>' +

Â  Â  Â  regions.map(r => `<option value="${r}">${REGION_LABEL[r] || r}</option>`).join('');

Â  }



Â  // ====== HELPERS ======

Â  function toGeoJSON(list){

Â  Â  return {

Â  Â  Â  type:'FeatureCollection',

Â  Â  Â  features: list.map(c => ({

Â  Â  Â  Â  type:'Feature',

Â  Â  Â  Â  properties: {

Â  Â  Â  Â  Â  id: c.id,

Â  Â  Â  Â  Â  name: c.name,

Â  Â  Â  Â  Â  country: c.country || '',

Â  Â  Â  Â  Â  region: c.region || '',

Â  Â  Â  Â  Â  phone: c.phone || '',

Â  Â  Â  Â  Â  email: c.email || '',

Â  Â  Â  Â  Â  serviceKey: c.services || '',

Â  Â  Â  Â  Â  logo: c.image?.url || ''

Â  Â  Â  Â  },

Â  Â  Â  Â  geometry:{ type:'Point', coordinates:[c.location.longitude, c.location.latitude] }

Â  Â  Â  }))

Â  Â  };

Â  }



Â  function popupHTML(p, lat, lng){

Â  Â  const regionTextÂ  = (REGION_LABEL[p.region] || p.region || '').trim();

Â  Â  const serviceText = (SERVICE_LABEL[p.serviceKey] || p.serviceKey || '').trim();

Â  Â  const phoneHTMLÂ  Â = p.phone ? `<a href="tel:${p.phone}">${p.phone}</a>` : '';

Â  Â  const emailHTMLÂ  Â = p.email ? `<a href="mailto:${p.email}">${p.email}</a>` : '';

Â  Â  // Corrected the directions URL format

Â  Â  const dirURLÂ  Â  Â  = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;



Â  Â  // Logo or fallback placeholder

Â  Â  const logoHTML = p.logoÂ 

Â  Â  Â  ? `<img src="${p.logo}" alt="${p.name} logo" style="max-width:100px; max-height:60px; display:block; margin-bottom:8px;">`

Â  Â  Â  : `<div style="width:100px;height:60px;background:#ccc;display:flex;align-items:center;justify-content:center;margin-bottom:8px;">No Logo</div>`;



Â  Â  return `

Â  Â  Â  <div class="popup">

Â  Â  Â  Â  ${logoHTML}

Â  Â  Â  Â  <h3>${p.name}</h3>

Â  Â  Â  Â  <p><strong>Region:</strong> ${regionText || 'â€”'}</p>

Â  Â  Â  Â  <p><strong>Country:</strong> ${p.country || 'â€”'}</p>

Â  Â  Â  Â  <p><strong>Contact Number:</strong> ${phoneHTML || 'â€”'}</p>

Â  Â  Â  Â  <p><strong>Email ID:</strong> ${emailHTML || 'â€”'}</p>

Â  Â  Â  Â  <p><strong>Service Range:</strong> ${serviceText || 'â€”'}</p>

Â  Â  Â  Â  <p><a target="_blank" href="${dirURL}">Get Directions</a></p>

Â  Â  Â  </div>`;

Â  }



Â  // ====== FILTER + RENDER (Region only) ======

Â  // MODIFIED: Added logic to move the map to the selected region

Â  function applyFiltersAndRender(){

Â  Â  const r = regionSelect.value;



Â  Â  const filtered = allCenters.filter(c => {

Â  Â  Â  const okR = !r || c.region === r;

Â  Â  Â  return okR;

Â  Â  });



Â  Â  currentGeo = toGeoJSON(filtered);

Â  Â  const src = map.getSource('svc');

Â  Â  if (src) {

Â  Â  Â  src.setData(currentGeo);

Â  Â  } else {

Â  Â  Â  // first render

Â  Â  Â  map.addSource('svc', { type:'geojson', data: currentGeo, cluster:true, clusterRadius:40 });

Â  Â  Â  map.addLayer({ id:'clusters', type:'circle', source:'svc',

Â  Â  Â  Â  filter:['has','point_count'],

Â  Â  Â  Â  paint:{ 'circle-radius':['step',['get','point_count'],16,10,22,30,30] } });

Â  Â  Â  map.addLayer({ id:'cluster-count', type:'symbol', source:'svc',

Â  Â  Â  Â  filter:['has','point_count'],

Â  Â  Â  Â  layout:{ 'text-field':['get','point_count_abbreviated'], 'text-size':12 } });

Â  Â  Â  map.addLayer({

Â  Â  Â  Â  id:'points',

Â  Â  Â  Â  type:'circle',

Â  Â  Â  Â  source:'svc',

Â  Â  Â  Â  filter:['!',['has','point_count']],

Â  Â  Â  Â  paint:{

Â  Â  Â  Â  Â  'circle-radius': 7,

Â  Â  Â  Â  Â  'circle-color': ['case', ['==', ['get', 'serviceKey'], 'fullCapabilityHub'], '#e11d48', '#000000'],

Â  Â  Â  Â  Â  'circle-stroke-width': 1,

Â  Â  Â  Â  Â  'circle-stroke-color': '#ffffff'

Â  Â  Â  Â  }

Â  Â  Â  });

Â  Â  Â  map.on('click','points', (e) => {

Â  Â  Â  Â  const f = e.features[0];

Â  Â  Â  Â  const p = f.properties;

Â  Â  Â  Â  const [lng,lat] = f.geometry.coordinates;

Â  Â  Â  Â  new mapboxgl.Popup().setLngLat([lng,lat]).setHTML(popupHTML(p, lat, lng)).addTo(map);

Â  Â  Â  });

Â  Â  Â  map.on('click','clusters', (e) => {

Â  Â  Â  Â  const feats = map.queryRenderedFeatures(e.point, { layers:['clusters'] });

Â  Â  Â  Â  const clusterId = feats[0].properties.cluster_id;

Â  Â  Â  Â  map.getSource('svc').getClusterExpansionZoom(clusterId, (err, zoom) => {

Â  Â  Â  Â  Â  if (err) return;

Â  Â  Â  Â  Â  map.easeTo({ center: feats[0].geometry.coordinates, zoom });

Â  Â  Â  Â  });

Â  Â  Â  });

Â  Â  }



Â  Â  // NEW LOGIC: Adjust map view based on filtered points

Â  Â  if (filtered.length > 0) {

Â  Â  Â  Â  const bounds = new mapboxgl.LngLatBounds();

Â  Â  Â  Â  filtered.forEach(center => {

Â  Â  Â  Â  Â  Â  if (center.location) {

Â  Â  Â  Â  Â  Â  Â  Â  bounds.extend([center.location.longitude, center.location.latitude]);

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  });



Â  Â  Â  Â  map.fitBounds(bounds, {

Â  Â  Â  Â  Â  Â  padding: 50,

Â  Â  Â  Â  Â  Â  maxZoom: 6

Â  Â  Â  Â  });

Â  Â  } else {

Â  Â  Â  Â  map.flyTo({ center: [20, 10], zoom: 2 });

Â  Â  }

Â  }



Â  // ====== REFRESH LOGIC ======

Â  async function refreshData({rebuildRegion=false} = {}){

Â  Â  const prevRegion = regionSelect.value;



Â  Â  allCenters = await fetchCenters();

Â  Â  if (rebuildRegion) buildRegionFilter(allCenters);



Â  Â  // restore region

Â  Â  regionSelect.value = prevRegion || '';



Â  Â  applyFiltersAndRender();

Â  }



Â  // ====== EVENTS ======

Â  regionSelect.onchangeÂ  = applyFiltersAndRender;



Â  locateBtn.onclick = () => {

Â  Â  if (!navigator.geolocation) return alert('Geolocation not supported');

Â  Â  navigator.geolocation.getCurrentPosition(pos=>{

Â  Â  Â  const { latitude, longitude } = pos.coords;

Â  Â  Â  map.flyTo({ center:[longitude, latitude], zoom: 6 });

Â  Â  Â  new mapboxgl.Marker({color:'#1f2937'}).setLngLat([longitude, latitude]).addTo(map);

Â  Â  });

Â  };



Â  refreshBtn.onclick = () => refreshData({rebuildRegion:true});

Â  setInterval(() => refreshData(), 60000);

Â  document.addEventListener('visibilitychange', () => { if (!document.hidden) refreshData(); });



Â  // ====== BOOT ======

Â  (async () => {

Â  Â  allCenters = await fetchCenters();

Â  Â  buildRegionFilter(allCenters);

Â  Â  regionSelect.value = 'EMEA'; // NEW: Sets the default selected region to EMEA

Â  Â  map.on('load', applyFiltersAndRender);

Â  })();

Â  </script>

</body>

</html>
